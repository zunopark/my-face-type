<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê´€ìƒ ë¶„ì„ ê²°ê³¼</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 40px;
    }
  </style>
</head>
<body>
  <h2>ğŸ‘¤ ê´€ìƒ ë¶„ì„ ê²°ê³¼</h2>
  <div id="label-container">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    let db;

    // 1. IndexedDB ì´ˆê¸°í™”
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("FaceAnalysisDB", 1);

        request.onupgradeneeded = function (event) {
          db = event.target.result;
          if (!db.objectStoreNames.contains("results")) {
            const store = db.createObjectStore("results", { keyPath: "id" });
            store.createIndex("timestamp", "timestamp", { unique: false });
          }
        };

        request.onsuccess = function (event) {
          db = event.target.result;
          resolve();
        };

        request.onerror = function (event) {
          reject("âŒ IndexedDB ì´ˆê¸°í™” ì‹¤íŒ¨");
        };
      });
    }

    // 2. íŠ¹ì • IDë¡œ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
    function getResultById(id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(["results"], "readonly");
        const store = transaction.objectStore("results");
        const request = store.get(id);

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject("âŒ ê²°ê³¼ ì¡°íšŒ ì‹¤íŒ¨");
      });
    }

    // 3. í™”ë©´ ë Œë”ë§
    function renderResult(data) {
      const container = document.getElementById("label-container");

      if (!data) {
        container.innerHTML = "<p style='color: red;'>ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      container.innerHTML = `
        <div class="face-summary-section">
          <div class="face-summary">${marked.parse(data.summary)}</div>
        </div>
        <div class="face-full-section-wrapper">
          <div class="face-full-report">${marked.parse(data.detail)}</div>
          ${data.paid ? "" : `
          <div class="result-mask">
            <div class="blur-overlay"></div>
            <div class="mask-text">
              <div class="mask-text-top">ë” ìì„¸í•œ ë‚´ìš©ì„ ë³´ì‹œë ¤ë©´ ê²°ì œë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.</div>
            </div>
          </div>`}
        </div>
      `;
    }

    // 4. ì‹¤í–‰
    window.addEventListener("DOMContentLoaded", async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get("id");

      if (!id) {
        document.getElementById("label-container").innerHTML = "<p style='color: red;'>ê²°ê³¼ IDê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      try {
        await initDB();
        const result = await getResultById(id);
        renderResult(result);
      } catch (err) {
        document.getElementById("label-container").innerHTML = "<p style='color: red;'>ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨</p>";
        console.error(err);
      }
    });
  </script>
</body>
</html>
