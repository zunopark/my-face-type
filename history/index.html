<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>마이 페이지 | 결제 내역</title>
    <link rel="stylesheet" href="../styles/style.css" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=person,favorite,face"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=East+Sea+Dokdo&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Yeon+Sung&display=swap");
      @font-face {
        font-family: "KimjungchulMyungjo-Bold";
        src: url("https://gcore.jsdelivr.net/gh/projectnoonnu/noonfonts_2302_01@1.0/KimjungchulMyungjo-Bold.woff2")
          format("woff2");
        font-style: normal;
      }

      /* 공통 카드 스타일 */
      .history_card {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        margin-bottom: 12px;
        border: 1px solid #f0f0f0;
      }
      .history_card a {
        display: flex;
        align-items: center;
        padding: 14px;
        gap: 14px;
        text-decoration: none;
        color: inherit;
      }
      .history_card .card_thumb {
        width: 56px;
        height: 56px;
        border-radius: 8px;
        object-fit: cover;
        flex-shrink: 0;
        background: #f5f5f5;
      }
      .history_card .card_info {
        flex: 1;
        min-width: 0;
      }
      .history_card .card_label {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
      }
      .history_card .card_sub {
        font-size: 12px;
        color: #999;
      }
      .history_card .card_date {
        font-size: 11px;
        color: #bbb;
        flex-shrink: 0;
      }

      /* 사주 - 썸네일 대신 이니셜 */
      .history_card.saju .card_thumb {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff5f5;
        border: 1px solid #ffe0e0;
        font-size: 18px;
        font-weight: 700;
        color: #e74c3c;
      }

      /* 궁합 - 두 사진 */
      .history_card.couple .couple_thumbs {
        display: flex;
        align-items: center;
        flex-shrink: 0;
      }
      .history_card.couple .couple_thumb {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .history_card.couple .couple_thumb:last-child {
        margin-left: -12px;
      }
    </style>
  </head>
  <body>
    <div class="main_body_wrap">
      <header id="history" class="header_chat_wrap"></header>

      <div class="resultHistory_wrap">
        <div class="resultHistory_title">
          <div>결제 내역 <span id="history-count"></span></div>
        </div>
        <div id="resultHistory"></div>
      </div>
      <div class="nav_wrap">
        <a href="/" class="nav_content">
          <span class="material-icons nav_icon">home</span>

          <div class="nav_title">전체 보기</div>
        </a>
        <a href="/history/" class="nav_content nav_seleted">
          <span class="material-icons nav_icon"> person </span>

          <div class="nav_title">지난 보고서</div>
        </a>
      </div>
      <div class="footer"></div>
    </div>

    <script>
      // ============ DB 설정 ============
      let faceDB, sajuDB, coupleDB;
      let allItems = []; // 모든 결제 내역

      // 관상 타입 라벨
      const FACE_TYPES = ["base", "wealth", "marriage", "love", "career"];
      const FACE_TYPE_LABEL = {
        base: "프리미엄 관상 심층 분석",
        wealth: "재물 관상 분석",
        marriage: "결혼 관상 분석",
        love: "연애 관상 분석",
        career: "직업 관상 분석",
      };

      // ============ DB 초기화 함수들 ============
      function openFaceDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open("FaceAnalysisDB", 1);
          req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains("results")) {
              db.createObjectStore("results", { keyPath: "id" });
            }
          };
          req.onsuccess = (e) => resolve(e.target.result);
          req.onerror = () => resolve(null); // DB 없어도 계속 진행
        });
      }

      function openSajuDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open("SajuLoveDB", 2);
          req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains("results")) {
              db.createObjectStore("results", { keyPath: "id" });
            }
          };
          req.onsuccess = (e) => resolve(e.target.result);
          req.onerror = () => resolve(null);
        });
      }

      function openCoupleDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open("CoupleAnalysisDB", 1);
          req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains("results")) {
              db.createObjectStore("results", { keyPath: "id" });
            }
          };
          req.onsuccess = (e) => resolve(e.target.result);
          req.onerror = () => resolve(null);
        });
      }

      function getAllFromDB(db) {
        if (!db) return Promise.resolve([]);
        return new Promise((resolve) => {
          try {
            const tx = db.transaction("results", "readonly");
            const store = tx.objectStore("results");
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = () => resolve([]);
          } catch (e) {
            resolve([]);
          }
        });
      }

      // ============ 데이터 수집 ============
      async function collectAllPaidItems() {
        const items = [];

        // 1. 관상 데이터
        const faceResults = await getAllFromDB(faceDB);
        faceResults.forEach((rec) => {
          if (!rec.reports) return;
          FACE_TYPES.forEach((t) => {
            const rep = rec.reports[t];
            if (rep && rep.paid) {
              items.push({
                category: "face",
                id: rec.id,
                type: t,
                img: rec.imageBase64,
                ts: rep.purchasedAt || rec.timestamp,
                label: FACE_TYPE_LABEL[t] || "관상 분석",
                link: `/base-report/?id=${rec.id}`,
              });
            }
          });
        });

        // 2. 사주 데이터
        const sajuResults = await getAllFromDB(sajuDB);
        sajuResults.forEach((rec) => {
          if (rec.paid) {
            items.push({
              category: "saju",
              id: rec.id,
              userName: rec.input?.userName || "사용자",
              birthDate: rec.input?.date || "",
              dayMaster: rec.sajuData?.dayMaster?.char || "",
              ts: rec.paidAt || rec.createdAt || new Date().toISOString(),
              label: "AI 연애 사주 분석",
              link: `/saju-love/saju-result/?id=${rec.id}`,
            });
          }
        });

        // 3. 궁합 데이터
        const coupleResults = await getAllFromDB(coupleDB);
        coupleResults.forEach((rec) => {
          if (rec.reports?.couple?.paid) {
            items.push({
              category: "couple",
              id: rec.id,
              img1: rec.image1Base64,
              img2: rec.image2Base64,
              ts: rec.reports.couple.purchasedAt || rec.timestamp,
              label: "AI 궁합 분석",
              link: `/couple-report/?id=${rec.id}`,
            });
          }
        });

        return items;
      }

      // ============ 렌더링 ============
      function renderHistory(items) {
        const $list = document.getElementById("resultHistory");
        const $count = document.getElementById("history-count");
        $list.innerHTML = "";

        $count.textContent = `(${items.length}개)`;

        // 빈 화면
        if (items.length === 0) {
          $list.innerHTML = `
            <div class="no-results">
              <p>결제한 분석 결과가 아직 없습니다.</p>
              <a href="/" class="view-face-button">AI 관상 보러 가기</a>
            </div>`;
          return;
        }

        // 최신순 정렬
        items.sort((a, b) => new Date(b.ts) - new Date(a.ts));

        // DOM 생성
        items.forEach((item) => {
          const div = document.createElement("div");
          const dateStr = new Date(item.ts).toLocaleDateString("ko-KR", {
            month: "numeric",
            day: "numeric",
          });

          if (item.category === "face") {
            div.className = "history_card face";
            div.innerHTML = `
              <a href="${item.link}">
                <img class="card_thumb" src="${item.img}" alt="" />
                <div class="card_info">
                  <div class="card_label">${item.label}</div>
                  <div class="card_sub">관상 분석</div>
                </div>
                <span class="card_date">${dateStr}</span>
              </a>`;
          } else if (item.category === "saju") {
            const dayChar = item.dayMaster || "?";
            div.className = "history_card saju";
            div.innerHTML = `
              <a href="${item.link}">
                <div class="card_thumb">${escapeHTML(dayChar)}</div>
                <div class="card_info">
                  <div class="card_label">${escapeHTML(
                    item.userName
                  )}님의 연애 사주</div>
                  <div class="card_sub">${escapeHTML(item.birthDate)}</div>
                </div>
                <span class="card_date">${dateStr}</span>
              </a>`;
          } else if (item.category === "couple") {
            div.className = "history_card couple";
            div.innerHTML = `
              <a href="${item.link}">
                <div class="couple_thumbs">
                  <img class="couple_thumb" src="${item.img1 || ""}" alt="" />
                  <img class="couple_thumb" src="${item.img2 || ""}" alt="" />
                </div>
                <div class="card_info">
                  <div class="card_label">궁합 분석</div>
                  <div class="card_sub">AI 궁합 리포트</div>
                </div>
                <span class="card_date">${dateStr}</span>
              </a>`;
          }

          $list.appendChild(div);
        });
      }

      function escapeHTML(str) {
        if (!str) return "";
        return str.replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );
      }

      // ============ 미결제 삭제 ============
      async function deleteUnpaidResults() {
        if (!confirm("결제하지 않은 히스토리를 모두 삭제할까요?")) return;

        // 관상 DB
        if (faceDB) {
          const tx = faceDB.transaction("results", "readwrite");
          const store = tx.objectStore("results");
          const req = store.getAll();
          req.onsuccess = () => {
            req.result.forEach((rec) => {
              const hasAnyPaid = FACE_TYPES.some((t) => rec.reports?.[t]?.paid);
              if (!hasAnyPaid) store.delete(rec.id);
            });
          };
        }

        // 사주 DB
        if (sajuDB) {
          const tx = sajuDB.transaction("results", "readwrite");
          const store = tx.objectStore("results");
          const req = store.getAll();
          req.onsuccess = () => {
            req.result.forEach((rec) => {
              if (!rec.paid) store.delete(rec.id);
            });
          };
        }

        // 궁합 DB
        if (coupleDB) {
          const tx = coupleDB.transaction("results", "readwrite");
          const store = tx.objectStore("results");
          const req = store.getAll();
          req.onsuccess = () => {
            req.result.forEach((rec) => {
              if (!rec.reports?.couple?.paid) store.delete(rec.id);
            });
          };
        }

        // 새로고침
        setTimeout(async () => {
          allItems = await collectAllPaidItems();
          renderHistory(allItems);
          alert("미결제 히스토리가 삭제되었습니다 ✅");
        }, 500);
      }

      // ============ 초기화 ============
      (async () => {
        // 모든 DB 열기
        [faceDB, sajuDB, coupleDB] = await Promise.all([
          openFaceDB(),
          openSajuDB(),
          openCoupleDB(),
        ]);

        console.log("✅ 모든 DB 초기화 완료");

        // 결제 내역 수집 및 렌더링
        allItems = await collectAllPaidItems();
        renderHistory(allItems);
      })();
    </script>

    <script src="../commonJs/footer.js"></script>
    <script src="../commonJs/headerCopy.js"></script>

    <script
      src="https://kit.fontawesome.com/47e166f8b9.js"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
