<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>관상 결제 완료 리포트</title>
    <style>
      body {
        font-family: "Pretendard", sans-serif;
        background: #f8f9fc;
        margin: 0;
      }
      .result-box {
        max-width: 400px;
        margin: 100px auto 0 auto;
        padding: 32px 28px;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.07);
        text-align: center;
      }
      .result-box h2 {
        font-size: 1.5em;
        margin-bottom: 24px;
      }
      .result-id,
      .result-type {
        margin: 18px 0;
        font-size: 1.13em;
        color: #156aff;
        font-weight: 500;
        word-break: break-all;
      }
      .success-emoji {
        font-size: 42px;
        margin-bottom: 14px;
      }
    </style>
  </head>
  <body>
    <div class="result-box">
      <div class="success-emoji">🎉</div>
      <h2>결제 성공!</h2>
      <div class="result-id">id: <span id="result-id"></span></div>
      <div class="result-type">type: <span id="result-type"></span></div>
    </div>
    <script>
      /* ───────── 0. 공통 유틸 ───────── */
      const qs = new URLSearchParams(location.search);
      const idRaw = (qs.get("id") || "").trim();
      const type = (qs.get("type") || "").trim(); // base / marriage / …
      const id = decodeURIComponent(idRaw); // 혹시 % 인코딩 대비

      document.getElementById("result-id").textContent = id || "(없음)";
      document.getElementById("result-type").textContent = type || "(없음)";

      /* ───────── 1. Mixpanel (선택) ───────── */
      let distinctId =
        localStorage.getItem("mixpanel_distinct_id") || crypto.randomUUID();
      localStorage.setItem("mixpanel_distinct_id", distinctId);

      mixpanel.init("d7d8d6afc10a92f911ea59901164605b", {
        debug: false,
        autotrack: true,
        persistence: "localStorage",
      });
      mixpanel.identify(distinctId);
      mixpanel.track("결제 콜백 페이지 진입", { id, type, url: location.href });

      /* ───────── 2. IndexedDB: FaceFeatureDB → reports[type].paid = true ───────── */
      function openFeatureDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open("FaceFeatureDB", 1);
          req.onerror = () => reject(req.error);
          req.onsuccess = () => resolve(req.result);
          req.onupgradeneeded = (e) => {
            // 최초 접속 대비
            const db = e.target.result;
            if (!db.objectStoreNames.contains("features")) {
              const store = db.createObjectStore("features", { keyPath: "id" });
              store.createIndex("timestamp", "timestamp");
            }
          };
        });
      }

      async function markPaid(id, type) {
        const db = await openFeatureDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(["features"], "readwrite");
          const st = tx.objectStore("features");
          const get = st.get(id);

          get.onerror = () => reject(get.error);
          get.onsuccess = () => {
            const data = get.result;
            if (!data || !data.reports?.[type])
              return reject("레코드/타입 불일치");
            data.reports[type].paid = true;
            data.reports[type].purchasedAt = new Date().toISOString();
            st.put(data).onsuccess = resolve;
          };
        });
      }

      /* ───────── 3. Toss 결제 컨펌 + 후처리 ───────── */
      async function confirmTossPayment() {
        const paymentKey = qs.get("paymentKey");
        const orderId = qs.get("orderId");
        const amountStr = qs.get("amount");
        const amountNum = Number(amountStr);

        if (!paymentKey || !orderId || !amountStr || !id || !type) {
          alert("결제 파라미터가 부족합니다. 관리자에게 문의해주세요.");
          return redirectHome(3000);
        }

        try {
          const res = await fetch(
            "https://port-0-momzzi-fastapi-m7ynssht4601229b.sel4.cloudtype.app/payment/confirm",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentKey, orderId, amount: amountNum }),
            }
          );
          if (!res.ok) {
            const msg = await res.text();
            throw new Error("서버 응답 오류: " + msg);
          }
          await res.json(); // 필요 시 값 사용

          /* 2-A. 로컬 DB 결제 완료 표시 */
          try {
            await markPaid(id, type);
          } catch (e) {
            console.warn("IndexedDB 업데이트 실패:", e);
          }

          /* 2-B. Mixpanel 성공 이벤트 */
          mixpanel.track("리포트 결제 성공", {
            id,
            type,
            amount: amountNum,
            orderId,
            paymentKey,
            timestamp: new Date().toISOString(),
          });

          /* 2-C. 2초 후 결과 페이지로 이동 */
          setTimeout(() => redirectResult(), 2000);
        } catch (err) {
          console.error(err);
          mixpanel.track("리포트 결제 실패", { id, type, error: err.message });
          alert("결제 확인에 실패했습니다.\n" + err.message);
          redirectHome(3000);
        }
      }

      /* ───────── 4. 리다이렉트 헬퍼 ───────── */
      function redirectResult() {
        location.href = `/analyze-result/?id=${encodeURIComponent(
          id
        )}&type=${type}`;
      }
      function redirectHome(delay = 0) {
        setTimeout(() => (location.href = "/"), delay);
      }

      /* ───────── 5. 실행 ───────── */
      document.addEventListener("DOMContentLoaded", confirmTossPayment);
    </script>
  </body>
</html>
