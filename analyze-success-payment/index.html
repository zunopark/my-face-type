<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê´€ìƒ ê²°ì œ ì™„ë£Œ ë¦¬í¬íŠ¸</title>
    <style>
      body {
        font-family: "Pretendard", sans-serif;
        background: #f8f9fc;
        margin: 0;
      }
      .result-box {
        max-width: 400px;
        margin: 100px auto 0 auto;
        padding: 32px 28px;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.07);
        text-align: center;
      }
      .result-box h2 {
        font-size: 1.5em;
        margin-bottom: 24px;
      }
      .result-id,
      .result-type {
        margin: 18px 0;
        font-size: 1.13em;
        color: #156aff;
        font-weight: 500;
        word-break: break-all;
      }
      .success-emoji {
        font-size: 42px;
        margin-bottom: 14px;
      }
    </style>
    <script type="text/javascript">
      (function (f, b) {
        if (!b.__SV) {
          var e, g, i, h;
          window.mixpanel = b;
          b._i = [];
          b.init = function (e, f, c) {
            function g(a, d) {
              var b = d.split(".");
              2 == b.length && ((a = a[b[0]]), (d = b[1]));
              a[d] = function () {
                a.push([d].concat(Array.prototype.slice.call(arguments, 0)));
              };
            }
            var a = b;
            "undefined" !== typeof c ? (a = b[c] = []) : (c = "mixpanel");
            a.people = a.people || [];
            a.toString = function (a) {
              var d = "mixpanel";
              "mixpanel" !== c && (d += "." + c);
              a || (d += " (stub)");
              return d;
            };
            a.people.toString = function () {
              return a.toString(1) + ".people (stub)";
            };
            i =
              "disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(
                " "
              );
            for (h = 0; h < i.length; h++) g(a, i[h]);
            var j = "set set_once union unset remove delete".split(" ");
            a.get_group = function () {
              function b(c) {
                d[c] = function () {
                  call2_args = arguments;
                  call2 = [c].concat(Array.prototype.slice.call(call2_args, 0));
                  a.push([e, call2]);
                };
              }
              for (
                var d = {},
                  e = ["get_group"].concat(
                    Array.prototype.slice.call(arguments, 0)
                  ),
                  c = 0;
                c < j.length;
                c++
              )
                b(j[c]);
              return d;
            };
            b._i.push([e, f, c]);
          };
          b.__SV = 1.2;
          e = f.createElement("script");
          e.type = "text/javascript";
          e.async = !0;
          e.src =
            "undefined" !== typeof MIXPANEL_CUSTOM_LIB_URL
              ? MIXPANEL_CUSTOM_LIB_URL
              : "file:" === f.location.protocol &&
                "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)
              ? "https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js"
              : "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";
          g = f.getElementsByTagName("script")[0];
          g.parentNode.insertBefore(e, g);
        }
      })(document, window.mixpanel || []);
    </script>
  </head>
  <body>
    <div class="result-box">
      <div class="success-emoji">ğŸ‰</div>
      <h2>ê²°ì œ ì„±ê³µ!</h2>
      <div class="result-id">id: <span id="result-id"></span></div>
      <div class="result-type">type: <span id="result-type"></span></div>
    </div>

    <script>
      // ê³ ìœ  ì‚¬ìš©ì IDë¥¼ localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ìƒˆë¡œ ìƒì„±
      let distinctId = localStorage.getItem("mixpanel_distinct_id");
      if (!distinctId) {
        distinctId = crypto.randomUUID(); // ë¸Œë¼ìš°ì € ë‚´ì¥ UUID ìƒì„±
        localStorage.setItem("mixpanel_distinct_id", distinctId);
      }

      // Mixpanel ì´ˆê¸°í™” ë° ID ì§€ì •
      mixpanel.init("d7d8d6afc10a92f911ea59901164605b", {
        debug: true,
        // optional: identify ìë™ í˜¸ì¶œ ì•ˆ ë˜ê²Œ í•˜ê³ , ì•„ë˜ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ identify
        autotrack: true,
        persistence: "localStorage",
      });

      // ì‚¬ìš©ì IDë¥¼ ëª…ì‹œì ìœ¼ë¡œ identify
      mixpanel.identify(distinctId);

      // ì¶”ì  ì˜ˆì‹œ
      mixpanel.track("ê´€ìƒ ê²°ì œ ì„±ê³µ í˜ì´ì§€ ì§„ì…", {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString(),
      });
    </script>

    <script>
      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ 0. ê³µí†µ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      const qs = new URLSearchParams(location.search);
      const idRaw = (qs.get("id") || "").trim();
      const type = (qs.get("type") || "").trim(); // baseâ€†/â€†marriageâ€†/â€†â€¦
      const id = decodeURIComponent(idRaw); // í˜¹ì‹œ % ì¸ì½”ë”© ëŒ€ë¹„

      document.getElementById("result-id").textContent = id || "(ì—†ìŒ)";
      document.getElementById("result-type").textContent = type || "(ì—†ìŒ)";

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. IndexedDB: FaceFeatureDB â†’ reports[type].paid = true â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      function openFeatureDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open("FaceFeatureDB", 1);
          req.onerror = () => reject(req.error);
          req.onsuccess = () => resolve(req.result);
          req.onupgradeneeded = (e) => {
            // ìµœì´ˆ ì ‘ì† ëŒ€ë¹„
            const db = e.target.result;
            if (!db.objectStoreNames.contains("features")) {
              const store = db.createObjectStore("features", { keyPath: "id" });
              store.createIndex("timestamp", "timestamp");
            }
          };
        });
      }

      async function markPaid(id, type) {
        const db = await openFeatureDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(["features"], "readwrite");
          const st = tx.objectStore("features");
          const get = st.get(id);

          get.onerror = () => reject(get.error);
          get.onsuccess = () => {
            const data = get.result;
            if (!data || !data.reports?.[type])
              return reject("ë ˆì½”ë“œ/íƒ€ì… ë¶ˆì¼ì¹˜");
            data.reports[type].paid = true;
            data.reports[type].purchasedAt = new Date().toISOString();
            st.put(data).onsuccess = resolve;
          };
        });
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Toss ê²°ì œ ì»¨íŒ + í›„ì²˜ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      async function confirmTossPayment() {
        const paymentKey = qs.get("paymentKey");
        const orderId = qs.get("orderId");
        const amountStr = qs.get("amount");
        const amountNum = Number(amountStr);

        if (!paymentKey || !orderId || !amountStr || !id || !type) {
          alert("ê²°ì œ íŒŒë¼ë¯¸í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.");
          return redirectHome(3000);
        }

        try {
          const res = await fetch(
            "https://port-0-momzzi-fastapi-m7ynssht4601229b.sel4.cloudtype.app/payment/confirm",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentKey, orderId, amount: amountNum }),
            }
          );
          if (!res.ok) {
            const msg = await res.text();
            throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + msg);
          }
          await res.json(); // í•„ìš” ì‹œ ê°’ ì‚¬ìš©

          /* 2-A. ë¡œì»¬ DB ê²°ì œ ì™„ë£Œ í‘œì‹œ */
          try {
            await markPaid(id, type);
          } catch (e) {
            console.warn("IndexedDB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", e);
          }

          /* 2-B. Mixpanel ì„±ê³µ ì´ë²¤íŠ¸ */
          mixpanel.track("ë¦¬í¬íŠ¸ ê²°ì œ ì„±ê³µ", {
            id,
            type,
            amount: amountNum,
            orderId,
            paymentKey,
            timestamp: new Date().toISOString(),
          });

          /* 2-C. 2ì´ˆ í›„ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™ */
          setTimeout(() => redirectResult(), 2000);
        } catch (err) {
          console.error(err);
          mixpanel.track("ë¦¬í¬íŠ¸ ê²°ì œ ì‹¤íŒ¨", { id, type, error: err.message });
          alert("ê²°ì œ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n" + err.message);
          redirectHome(3000);
        }
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. ë¦¬ë‹¤ì´ë ‰íŠ¸ í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      function redirectResult() {
        location.href = `/analyze-result/?id=${encodeURIComponent(
          id
        )}&type=${type}`;
      }
      function redirectHome(delay = 0) {
        setTimeout(() => (location.href = "/"), delay);
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. ì‹¤í–‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      document.addEventListener("DOMContentLoaded", confirmTossPayment);
    </script>
  </body>
</html>
