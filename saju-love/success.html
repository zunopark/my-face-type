<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>결제 확인 | 연애 사주</title>

    <!-- 믹스패널 -->
    <script type="text/javascript">
      (function (f, b) {
        if (!b.__SV) {
          var e, g, i, h;
          window.mixpanel = b;
          b._i = [];
          b.init = function (e, f, c) {
            function g(a, d) {
              var b = d.split(".");
              2 == b.length && ((a = a[b[0]]), (d = b[1]));
              a[d] = function () {
                a.push([d].concat(Array.prototype.slice.call(arguments, 0)));
              };
            }
            var a = b;
            "undefined" !== typeof c ? (a = b[c] = []) : (c = "mixpanel");
            a.people = a.people || [];
            a.toString = function (a) {
              var d = "mixpanel";
              "mixpanel" !== c && (d += "." + c);
              a || (d += " (stub)");
              return d;
            };
            a.people.toString = function () {
              return a.toString(1) + ".people (stub)";
            };
            i =
              "disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(
                " "
              );
            for (h = 0; h < i.length; h++) g(a, i[h]);
            var j = "set set_once union unset remove delete".split(" ");
            a.get_group = function () {
              function b(c) {
                d[c] = function () {
                  call2_args = arguments;
                  call2 = [c].concat(Array.prototype.slice.call(call2_args, 0));
                  a.push([e, call2]);
                };
              }
              for (
                var d = {},
                  e = ["get_group"].concat(
                    Array.prototype.slice.call(arguments, 0)
                  ),
                  c = 0;
                c < j.length;
                c++
              )
                b(j[c]);
              return d;
            };
            b._i.push([e, f, c]);
          };
          b.__SV = 1.2;
          e = f.createElement("script");
          e.type = "text/javascript";
          e.async = !0;
          e.src =
            "undefined" !== typeof MIXPANEL_CUSTOM_LIB_URL
              ? MIXPANEL_CUSTOM_LIB_URL
              : "file:" === f.location.protocol &&
                "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)
              ? "https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js"
              : "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";
          g = f.getElementsByTagName("script")[0];
          g.parentNode.insertBefore(e, g);
        }
      })(document, window.mixpanel || []);

      // Mixpanel 초기화
      function safeUUID() {
        if (crypto.randomUUID) return crypto.randomUUID();
        return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, (c) =>
          (
            c ^
            (crypto.getRandomValues(new Uint8Array(1))[0] & (15 >> (c / 4)))
          ).toString(16)
        );
      }

      let distinctId = localStorage.getItem("mixpanel_distinct_id");
      if (!distinctId) {
        distinctId = safeUUID();
        localStorage.setItem("mixpanel_distinct_id", distinctId);
      }

      mixpanel.init("d7d8d6afc10a92f911ea59901164605b", {
        debug: true,
        autotrack: true,
        persistence: "localStorage",
      });

      mixpanel.identify(distinctId);
    </script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #fff9f9;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
      .container {
        text-align: center;
        max-width: 400px;
        width: 100%;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #ffe0e0;
        border-top-color: #e74c3c;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 24px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      #status {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin-bottom: 12px;
      }
      #status.success {
        color: #27ae60;
      }
      #status.fail {
        color: #e74c3c;
      }
      .sub-text {
        font-size: 14px;
        color: #666;
        margin-bottom: 24px;
      }
      #retryBtn {
        padding: 12px 24px;
        font-size: 15px;
        font-weight: 600;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="spinner" id="spinner"></div>
      <h2 id="status">결제 확인 중...</h2>
      <p class="sub-text" id="subText">잠시만 기다려주세요</p>
      <button id="retryBtn">다시 시도</button>
    </div>

    <script>
      // URL 파라미터
      const qs = new URLSearchParams(location.search);
      const paymentKey = qs.get("paymentKey");
      const orderId = qs.get("orderId");
      const amount = Number(qs.get("amount"));
      const resultId = qs.get("id");

      // API 엔드포인트
      const PAYMENT_CONFIRM_API =
        "https://port-0-momzzi-fastapi-m7ynssht4601229b.sel4.cloudtype.app/payment/confirm";

      // IndexedDB 설정
      const DB_NAME = "SajuLoveDB";
      const DB_VERSION = 2;
      const STORE_NAME = "results";

      // DOM 요소
      const statusEl = document.getElementById("status");
      const subTextEl = document.getElementById("subText");
      const spinnerEl = document.getElementById("spinner");
      const retryBtn = document.getElementById("retryBtn");

      // IndexedDB 열기
      function openDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onerror = () => reject(req.error);
          req.onsuccess = (e) => resolve(e.target.result);
        });
      }

      // paid 상태 저장
      function markAsPaid(db, id) {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, "readwrite");
          const store = tx.objectStore(STORE_NAME);
          const getReq = store.get(id);

          getReq.onsuccess = () => {
            const data = getReq.result;
            if (data) {
              data.paid = true;
              data.paidAt = new Date().toISOString();
              const putReq = store.put(data);
              putReq.onsuccess = () => resolve(data);
              putReq.onerror = () => reject(putReq.error);
            } else {
              reject(new Error("데이터를 찾을 수 없습니다."));
            }
          };
          getReq.onerror = () => reject(getReq.error);
        });
      }

      // fetch with timeout
      function fetchWithTimeout(url, opts = {}, ms = 10000) {
        return Promise.race([
          fetch(url, opts),
          new Promise((_, rej) =>
            setTimeout(() => rej(new Error("TIMEOUT")), ms)
          ),
        ]);
      }

      // 메인 플로우
      const MAX_RETRY = 3;
      const BASE_DELAY = 1500;

      async function confirmPayment(attempt = 1) {
        try {
          // 1. 결제 확인
          statusEl.textContent = "결제 확인 중...";
          subTextEl.textContent = "잠시만 기다려주세요";

          const res = await fetchWithTimeout(
            PAYMENT_CONFIRM_API,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentKey, orderId, amount }),
            },
            10000
          );

          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          await res.json();

          // 2. 결제 성공 - paid 상태 저장
          statusEl.textContent = "결제 완료!";
          statusEl.className = "success";
          subTextEl.textContent = "결과 페이지로 이동합니다";

          // Mixpanel 결제 성공 트래킹
          mixpanel.track("연애 사주 결제 완료", {
            orderId: orderId,
            amount: amount,
            timestamp: new Date().toISOString(),
          });

          const db = await openDB();
          await markAsPaid(db, resultId);

          // 3. 바로 결과 페이지로 이동 (로딩은 결과 페이지에서)
          setTimeout(() => {
            location.href = `/saju-love/saju-result/?id=${encodeURIComponent(
              resultId
            )}`;
          }, 500);
        } catch (err) {
          console.error(`[${attempt}] 결제 확인 실패:`, err.message);

          if (attempt < MAX_RETRY) {
            statusEl.textContent = `재시도 중... (${attempt}/${MAX_RETRY})`;
            const delay = BASE_DELAY * Math.pow(2, attempt - 1);
            setTimeout(() => confirmPayment(attempt + 1), delay);
          } else {
            // 최종 실패
            spinnerEl.style.display = "none";
            statusEl.textContent = "결제 확인 실패";
            statusEl.className = "fail";
            subTextEl.textContent = err.message || "다시 시도해주세요";
            retryBtn.style.display = "inline-block";

            // Mixpanel 결제 실패 트래킹
            mixpanel.track("연애 사주 결제 실패", {
              orderId: orderId,
              amount: amount,
              error: err.message,
              timestamp: new Date().toISOString(),
            });
          }
        }
      }

      // 재시도 버튼
      retryBtn.addEventListener("click", () => {
        retryBtn.style.display = "none";
        spinnerEl.style.display = "block";
        statusEl.className = "";
        confirmPayment();
      });

      // 시작
      confirmPayment();
    </script>
  </body>
</html>
