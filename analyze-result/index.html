<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="AI ê´€ìƒê°€ ì–‘ë°˜ì´ ì•Œë ¤ì£¼ëŠ” ë‹¹ì‹ ì˜ ê´€ìƒ | ê´€ìƒ í…ŒìŠ¤íŠ¸ | ê´€ìƒê°€ ì–‘ë°˜"
    />
    <meta
      name="keywords"
      content="ê´€ìƒ, ê´€ìƒê°€ ì–‘ë°˜, ì‚¬ì£¼, ìš´ì„¸, AI, ì¸ê³µì§€ëŠ¥ì´ ì•Œë ¤ì£¼ëŠ” ê´€ìƒ, ì¸ê³µì§€ëŠ¥, ê´€ìƒ í…ŒìŠ¤íŠ¸"
    />
    <meta name="author" content="ê´€ìƒê°€ ì–‘ë°˜ | Nmax" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="AI ê´€ìƒ í…ŒìŠ¤íŠ¸ | ê´€ìƒê°€ ì–‘ë°˜" />
    <meta
      property="og:description"
      content="AI ê´€ìƒê°€ ì–‘ë°˜ì´ ì•Œë ¤ì£¼ëŠ” ë‹¹ì‹ ì˜ ê´€ìƒ | ê´€ìƒ í…ŒìŠ¤íŠ¸ | ê´€ìƒê°€ ì–‘ë°˜"
    />
    <meta property="og:image" content="https://i.ibb.co/nPD5mmK/face.png" />
    <meta
      name="google-site-verification"
      content="5jMrJKVs7H177f1geuB5P3ich8NWoORj_j7ihOOSarQ"
    />
    <meta
      name="google-site-verification"
      content="1OfOPLe0KtYlpDARcO1LVhTvWfNRNKndeIhnkYo_i34"
    />
    <link rel="canonical" href="https://keen-poitras-075b07.netlify.app" />
    <link rel="stylesheet" href="testStyles/style.css" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
      integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU"
      crossorigin="anonymous"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=East+Sea+Dokdo&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Yeon+Sung&display=swap");
      @font-face {
        font-family: "KimjungchulMyungjo-Bold";
        src: url("https://gcore.jsdelivr.net/gh/projectnoonnu/noonfonts_2302_01@1.0/KimjungchulMyungjo-Bold.woff2")
          format("woff2");
        font-style: normal;
      }
    </style>

    <title>AI ê´€ìƒ í…ŒìŠ¤íŠ¸ | ê´€ìƒê°€ ì–‘ë°˜</title>
    <meta
      name="naver-site-verification"
      content="95cd8990ed3962c82f8898a9372ce4b24dddbcb9"
    />

    <meta
      name="naver-site-verification"
      content="d2a00bde5ae1184c75d29957787926125e1183c8"
    />

    <link
      rel="shortcut icon"
      href="https://keen-poitras-075b07.netlify.app/favicon.ico"
      type="image/x-icon"
    />

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=UA-119161496-1"
    ></script>

    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "UA-119161496-1");
      gtag("config", "G-5TZETSPG3B");
    </script>

    <!-- google ad manager reward sdk  -->
    <script
      async
      src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"
    ></script>

    <script type="text/javascript">
      if (typeof history.pushState == "function") {
        var CatagoryURL = location.href;
        CatagoryURL = CatagoryURL.replace(/\?category=([0-9]+)/gi, "");
        history.pushState(null, null, CatagoryURL);
      }
    </script>

    <!-- ì¹´ì¹´ì˜¤ ê³µìœ  ë§í¬  -->
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <script>
      Kakao.init("4ff46443835291514c5a215357a6c4c1");
      Kakao.isInitialized();
    </script>

    <!-- Paste this right before your closing </head> tag -->
    <script type="text/javascript">
      (function (f, b) {
        if (!b.__SV) {
          var e, g, i, h;
          window.mixpanel = b;
          b._i = [];
          b.init = function (e, f, c) {
            function g(a, d) {
              var b = d.split(".");
              2 == b.length && ((a = a[b[0]]), (d = b[1]));
              a[d] = function () {
                a.push([d].concat(Array.prototype.slice.call(arguments, 0)));
              };
            }
            var a = b;
            "undefined" !== typeof c ? (a = b[c] = []) : (c = "mixpanel");
            a.people = a.people || [];
            a.toString = function (a) {
              var d = "mixpanel";
              "mixpanel" !== c && (d += "." + c);
              a || (d += " (stub)");
              return d;
            };
            a.people.toString = function () {
              return a.toString(1) + ".people (stub)";
            };
            i =
              "disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(
                " "
              );
            for (h = 0; h < i.length; h++) g(a, i[h]);
            var j = "set set_once union unset remove delete".split(" ");
            a.get_group = function () {
              function b(c) {
                d[c] = function () {
                  call2_args = arguments;
                  call2 = [c].concat(Array.prototype.slice.call(call2_args, 0));
                  a.push([e, call2]);
                };
              }
              for (
                var d = {},
                  e = ["get_group"].concat(
                    Array.prototype.slice.call(arguments, 0)
                  ),
                  c = 0;
                c < j.length;
                c++
              )
                b(j[c]);
              return d;
            };
            b._i.push([e, f, c]);
          };
          b.__SV = 1.2;
          e = f.createElement("script");
          e.type = "text/javascript";
          e.async = !0;
          e.src =
            "undefined" !== typeof MIXPANEL_CUSTOM_LIB_URL
              ? MIXPANEL_CUSTOM_LIB_URL
              : "file:" === f.location.protocol &&
                "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)
              ? "https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js"
              : "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";
          g = f.getElementsByTagName("script")[0];
          g.parentNode.insertBefore(e, g);
        }
      })(document, window.mixpanel || []);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div class="main_body_wrap">
      <header id="face" class="header"></header>
      <header class="header_chat">
        <div class="header_chat_wrap">
          <a class="header_chat_title" href="/test.html"> â† ë’¤ë¡œê°€ê¸° </a>
        </div>
      </header>
      <div class="main_content_wrap">
        <div class="main__ai__title">
          <div class="subtitle" style="margin-top: 32px">
            ê´€ìƒê°€ ì–‘ë°˜<br />
            <span style="font-size: 16px; color: #d3d3d3"
              >ëŒ€í•œë¯¼êµ­ 1ë“± AI ê´€ìƒ ì„œë¹„ìŠ¤</span
            >
          </div>
        </div>
        <div class="border">
          <div class="frame">
            <div class="image">
              <script
                class="jsbin"
                src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"
              ></script>
              <div class="file-upload">
                <div class="image-upload-wrap">
                  <input
                    class="file-upload-input"
                    type="file"
                    onchange="readURL(this);"
                    accept="image/*"
                  />
                </div>
                <div class="file-upload-content">
                  <div class="image-square-frame">
                    <img
                      class="file-upload-image"
                      id="face-image"
                      src="#"
                      alt="your image"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="label-container" class="result"></div>
        <div
          id="result-content"
          style="padding: 24px; font-family: sans-serif"
        ></div>
      </div>

      <footer class="footer"></footer>
    </div>

    <script>
      // ê³ ìœ  ì‚¬ìš©ì IDë¥¼ localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ìƒˆë¡œ ìƒì„±
      let distinctId = localStorage.getItem("mixpanel_distinct_id");
      if (!distinctId) {
        distinctId = crypto.randomUUID(); // ë¸Œë¼ìš°ì € ë‚´ì¥ UUID ìƒì„±
        localStorage.setItem("mixpanel_distinct_id", distinctId);
      }

      // Mixpanel ì´ˆê¸°í™” ë° ID ì§€ì •
      mixpanel.init("d7d8d6afc10a92f911ea59901164605b", {
        debug: true,
        // optional: identify ìë™ í˜¸ì¶œ ì•ˆ ë˜ê²Œ í•˜ê³ , ì•„ë˜ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ identify
        autotrack: true,
        persistence: "localStorage",
      });

      // ì‚¬ìš©ì IDë¥¼ ëª…ì‹œì ìœ¼ë¡œ identify
      mixpanel.identify(distinctId);

      // ì¶”ì  ì˜ˆì‹œ
      mixpanel.track("ê´€ìƒ í˜ì´ì§€ ë°©ë¬¸", {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString(),
      });
    </script>

    <script src="testJs/footer.js"></script>
    <script src="testJs/header.js"></script>
    <script src="testJs/livetime.js"></script>
    <script src="testJs/ad.js"></script>

    <script src="https://gcore.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://gcore.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <script
      data-cfasync="false"
      type="text/javascript"
      src="https://cdn.rawgit.com/dwyl/html-form-send-email-via-google-script-without-server/master/form-submission-handler.js"
    ></script>

    <script>
      let featureDb = null;

      // 1. IndexedDB ì—°ê²°
      function initFeatureDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open("FaceFeatureDB", 1);
          request.onsuccess = (event) => {
            featureDb = event.target.result;
            resolve();
          };
          request.onerror = reject;
        });
      }

      // 2. ì£¼ì†Œì—ì„œ id, type ì¶”ì¶œ
      function getIdAndTypeFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return {
          id: params.get("id"),
          type: params.get("type"),
        };
      }

      // 3. IndexedDBì—ì„œ feature ì¶”ì¶œ
      function getFeatureById(id) {
        return new Promise((resolve, reject) => {
          const tx = featureDb.transaction(["features"], "readonly");
          const store = tx.objectStore("features");
          const request = store.get(id);
          request.onsuccess = () => resolve(request.result);
          request.onerror = reject;
        });
      }

      // ğŸ”µ ì‚¬ì§„ ì˜ì—­ ë Œë”ë§
      function renderImage(imageBase64) {
        document.querySelector(".file-upload-image").src = imageBase64;
        document.querySelector(".file-upload-content").style.display = "block";
        document.querySelector(".image-upload-wrap").style.display = "none";
      }

      // 4. FastAPIë¡œ feature, type POSTí•´ì„œ ê²°ê³¼ ë°›ê¸°
      async function fetchFaceReport(feature) {
        console.log("test");
        const url =
          "https://port-0-momzzi-fastapi-m7ynssht4601229b.sel4.cloudtype.app/analyze/base";
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ feature }),
        });
        console.log("ì‘ë‹µ ì½”ë“œ:", res.status);
        let text = await res.text();
        console.log("ì‘ë‹µ ë³¸ë¬¸:", text);
        if (!res.ok) throw new Error("API ì˜¤ë¥˜: " + text);
        return JSON.parse(text);
      }

      // 5. ê²°ê³¼ ë¿Œë¦¬ê¸°
      function renderResult({ summary, detail }) {
        if (!summary || !detail) {
          document.querySelector(".result").innerHTML = `
      <span style="color:red">
        ë¦¬í¬íŠ¸ ìƒì„± ì˜¤ë¥˜: ì„œë²„ì—ì„œ ì˜¬ë°”ë¥¸ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br/>
        (summary/detailì´ ë¹„ì–´ ìˆìŒ)
      </span>
    `;
          return;
        }
        document.querySelector(".result").innerHTML = `
          <div class="result-summary" style="margin-bottom:16px">${marked.parse(
            summary
          )}</div>
          <div class="result-detail">${marked.parse(detail)}</div>
        `;
      }

      window.onload = async () => {
        const resultBox = document.querySelector(".result");
        function show(msg) {
          resultBox.innerHTML = `<span style="color:red;white-space:pre-line">${msg}</span>`;
        }

        try {
          resultBox.innerHTML = "â³ ë°ì´í„° ë¡œë”© ì¤‘...";

          // âœ… 1. DB ì—´ê¸° (with objectStore ì¡´ì¬ í™•ì¸)
          await new Promise((resolve, reject) => {
            const request = indexedDB.open("FaceFeatureDB", 1);
            request.onsuccess = (e) => {
              featureDb = e.target.result;
              if (!featureDb.objectStoreNames.contains("features")) {
                show("âŒ IndexedDBì— 'features' ìŠ¤í† ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                reject(new Error("Object store missing"));
              } else {
                resolve();
              }
            };
            request.onerror = () => {
              show("âŒ IndexedDB ì—´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              reject(request.error);
            };
          });

          // âœ… 2. URL íŒŒë¼ë¯¸í„°ì—ì„œ id/type ì¶”ì¶œ
          const params = new URLSearchParams(location.search);
          const id = params.get("id");
          const type = params.get("type");
          if (!id || !type) {
            show("âŒ URLì—ì„œ id ë˜ëŠ” typeì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          // âœ… 3. ì—¬ëŸ¬ ë²ˆ ì‹œë„í•´ì„œ getFeatureById ì‹¤í–‰
          const data = await (async () => {
            for (let i = 0; i < 10; i++) {
              try {
                const tx = featureDb.transaction(["features"], "readonly");
                const store = tx.objectStore("features");
                const req = store.get(id);

                const data = await new Promise((res, rej) => {
                  req.onsuccess = () => res(req.result);
                  req.onerror = () => rej(req.error);
                });

                if (data) return data;
              } catch (e) {
                console.warn(`ğŸŸ¡ get ì‹¤íŒ¨ ì‹œë„ ${i + 1}:`, e);
              }
              await new Promise((r) => setTimeout(r, 300));
            }
            return null;
          })();

          if (!data) {
            show(`âŒ í•´ë‹¹ IDë¡œ ë¶„ì„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n(id=${id})`);
            return;
          }

          if (!data.features) {
            show(
              "âŒ features í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë¶„ì„ì— ì‹¤íŒ¨í•œ ë°ì´í„°ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            );
            return;
          }

          if (data.imageBase64) {
            renderImage(data.imageBase64);
          }

          if (data.reports?.base?.paid) {
            renderResult({
              summary: data.reports.base.summary,
              detail: data.reports.base.detail,
            });
            return;
          }

          // âœ… 4. ê²°ê³¼ ìƒì„± ìš”ì²­
          resultBox.innerHTML = `<div class="result-waiting" style="font-size:20px;padding:32px 0;text-align:center;">
      <span>ë¦¬í¬íŠ¸ë¥¼ ìƒì„±ì¤‘ì…ë‹ˆë‹¤.<br/>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</span>
      <div style="margin-top:20px;font-size:34px;">â³</div>
    </div>`;

          try {
            const report = await fetchFaceReport(data.features);

            if (!report.summary || !report.detail) {
              show("âŒ ì„œë²„ì—ì„œ ë¹„ì–´ìˆëŠ” summary/detailì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.");
              return;
            }

            renderResult(report);

            data.reports = data.reports || {};
            data.reports.base = {
              paid: true,
              detail: report.detail,
              summary: report.summary,
              purchasedAt: new Date().toISOString(),
            };

            await saveFeatureToDB(data);
          } catch (err) {
            show("âŒ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
          }
        } catch (err) {
          show("âŒ ì „ì²´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + (err.message || err));
        }
      };

      // IndexedDB ì—…ë°ì´íŠ¸ (ìˆ˜ì •/ì €ì¥)
      async function saveFeatureToDB(data) {
        return new Promise((resolve, reject) => {
          const tx = featureDb.transaction(["features"], "readwrite");
          const store = tx.objectStore("features");
          const req = store.put(data); // ê°™ì€ idë©´ overwrite
          req.onsuccess = () => resolve();
          req.onerror = (e) => reject(e);
        });
      }
    </script>
  </body>
</html>
