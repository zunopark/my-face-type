<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>ê´€ìƒ ë¶„ì„ ê¸°ë¡</title>
    <link rel="stylesheet" href="styles/style.css" />
  </head>
  <body>
    <div class="main_body_wrap">
      <header id="face" class="header"></header>
      <header class="header_chat">
        <div class="header_chat_wrap">
          <a class="header_chat_title" href="/"> ê´€ìƒ </a>
          <!-- <a class="header_chat_title" href="/premium">
            í”„ë¦¬ë¯¸ì—„
          </a> -->
          <a class="header_chat_title" href="/animalface"> ë™ë¬¼ìƒ </a>

          <a class="header_chat_title" href="/premium"> ì¬ë¬¼ ê´€ìƒ </a>
          <a
            href="/history.html"
            class="header_chat_title header_chat_right header_selected"
            >ì§€ë‚œ ê´€ìƒ</a
          >
        </div>
      </header>
      <div class="resultHistory_wrap">
        <div class="resultHistory_title">
          <div>ê´€ìƒ ë¶„ì„ íˆìŠ¤í† ë¦¬ <span id="history-count"></span></div>
          <button id="clear-unpaid" class="clear-btn">
            ë¯¸ê²°ì œ íˆìŠ¤í† ë¦¬ ì‚­ì œ
          </button>
        </div>
        <div id="resultHistory"></div>
      </div>
    </div>

    <script>
      let db;

      async function initDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open("FaceAnalysisDB", 1);

          request.onupgradeneeded = function (event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains("results")) {
              const store = db.createObjectStore("results", { keyPath: "id" });
              store.createIndex("timestamp", "timestamp", { unique: false });
            }
          };

          request.onsuccess = function (event) {
            db = event.target.result;
            console.log("âœ… IndexedDB ì´ˆê¸°í™” ì™„ë£Œ");
            resolve(); // âœ… ì—¬ê¸°ê°€ ì¤‘ìš”
          };

          request.onerror = function (event) {
            console.error("âŒ IndexedDB ì˜¤ë¥˜", event);
            reject(event);
          };
        });
      }

      function getAllResults() {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(["results"], "readonly");
          const store = transaction.objectStore("results");
          const request = store.getAll();

          request.onsuccess = () => resolve(request.result);
          request.onerror = reject;
        });
      }

      function renderHistory(results) {
        const container = document.getElementById("resultHistory");

        if (results.length === 0) {
          container.innerHTML = `
      <div class="no-results">
        <p>ì•„ì§ ë¶„ì„í•œ ê´€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <a href="/" class="view-face-button">AI ê´€ìƒ ë³´ëŸ¬ ê°€ê¸°</a>
      </div>
    `;
          return;
        }

        // ê²°ê³¼ ìˆ˜ í‘œì‹œ
        document.getElementById(
          "history-count"
        ).textContent = `(${results.length}ê°œ)`;

        results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        results.forEach((r) => {
          const div = document.createElement("div");
          div.className = "resultHistory " + (r.paid ? "paid" : "unpaid");
          div.innerHTML = `
            <a href="/result.html?id=${r.id}">
        

            <div class="resultHistory_paid">${
              r.paid ? "âœ… ê²°ì œ ì™„ë£Œ" : "ğŸ”’ ìƒì„¸ ë¶„ì„ ë¯¸ê²°ì œ"
            }</div>
            <div class="resultHistory_image_wrap">
                <div class="image_square_frame2">
                    <img
                        class="resultHistory_image"
                        src="${r.imageBase64}"
                        alt="AI ê´€ìƒ ë¶„ì„ ê²°ê³¼"
                    />
                </div>
                <div class="resultHistory_summary">${r.summary}</div>
            </div>
          
            <div class="resultHistory_bottom">ğŸ‘‰ ìƒì„¸ ë³´ê¸°</div>
            <div class="resultHistory_date">${new Date(
              r.timestamp
            ).toLocaleString()}</div>
      </a>
    `;
          container.appendChild(div);
        });
      }

      (async () => {
        await initDB();
        const results = await getAllResults();
        renderHistory(results);
      })();

      /* === ë¯¸ê²°ì œ íˆìŠ¤í† ë¦¬ ì¼ê´„ ì‚­ì œ === */
      async function deleteUnpaidResults() {
        if (!confirm("ê²°ì œí•˜ì§€ ì•Šì€ íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;

        // 1) IndexedDB íŠ¸ëœì­ì…˜(ì“°ê¸°)
        const tx = db.transaction(["results"], "readwrite");
        const store = tx.objectStore("results");

        // 2) ì „ì²´ ìˆœíšŒí•˜ë©´ì„œ unpaidë§Œ ì‚­ì œ
        const getAllReq = store.getAll();
        getAllReq.onsuccess = () => {
          getAllReq.result.forEach((item) => {
            if (!item.paid) store.delete(item.id);
          });
        };

        // 3) ì™„ë£Œë˜ë©´ í™”ë©´ ê°±ì‹ 
        tx.oncomplete = async () => {
          // Container ë¹„ìš°ê³  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
          document.getElementById("resultHistory").innerHTML = "";
          const refreshed = await getAllResults();
          renderHistory(refreshed);
          alert("ë¯¸ê²°ì œ íˆìŠ¤í† ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤ âœ…");
        };

        tx.onerror = (e) => {
          console.error("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜", e);
          alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        };
      }

      /* ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ */
      document
        .getElementById("clear-unpaid")
        .addEventListener("click", deleteUnpaidResults);
    </script>
  </body>
</html>
