<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ê²°ì œ ì„±ê³µ</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 40px;
      }
      .success {
        font-size: 20px;
        color: green;
      }
      .fail {
        font-size: 20px;
        color: red;
      }
    </style>

    <!-- â”€â”€â”€â”€â”€ Mixpanel JS Stub (ê³µì‹) â”€â”€â”€â”€â”€ -->
    <script type="text/javascript">
      (function (f, b) {
        if (!b.__SV) {
          var e, g, i, h;
          window.mixpanel = b;
          b._i = [];
          b.init = function (e, f, c) {
            function g(a, d) {
              var b = d.split(".");
              2 == b.length && ((a = a[b[0]]), (d = b[1]));
              a[d] = function () {
                a.push([d].concat(Array.prototype.slice.call(arguments, 0)));
              };
            }
            var a = b;
            "undefined" !== typeof c ? (a = b[c] = []) : (c = "mixpanel");
            a.people = a.people || [];
            a.toString = function (a) {
              var d = "mixpanel";
              "mixpanel" !== c && (d += "." + c);
              a || (d += " (stub)");
              return d;
            };
            a.people.toString = function () {
              return a.toString(1) + ".people (stub)";
            };
            i =
              "disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(
                " "
              );
            for (h = 0; h < i.length; h++) g(a, i[h]);
            var j = "set set_once union unset remove delete".split(" ");
            a.get_group = function () {
              function b(c) {
                d[c] = function () {
                  call2_args = arguments;
                  call2 = [c].concat(Array.prototype.slice.call(call2_args, 0));
                  a.push([e, call2]);
                };
              }
              for (
                var d = {},
                  e = ["get_group"].concat(
                    Array.prototype.slice.call(arguments, 0)
                  ),
                  c = 0;
                c < j.length;
                c++
              )
                b(j[c]);
              return d;
            };
            b._i.push([e, f, c]);
          };
          b.__SV = 1.2;
          e = f.createElement("script");
          e.type = "text/javascript";
          e.async = !0;
          e.src =
            "undefined" !== typeof MIXPANEL_CUSTOM_LIB_URL
              ? MIXPANEL_CUSTOM_LIB_URL
              : "file:" === f.location.protocol &&
                "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)
              ? "https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js"
              : "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";
          g = f.getElementsByTagName("script")[0];
          g.parentNode.insertBefore(e, g);
        }
      })(document, window.mixpanel || []);
    </script>
  </head>
  <body>
    <h2 id="status">ğŸ”„ ê²°ì œ í™•ì¸ ì¤‘...</h2>
    <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>

    <!-- â”€â”€â”€â”€â”€ Mixpanel ì´ˆê¸°í™” & ì²« ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€ -->
    <script>
      /* ê³ ìœ  ì‚¬ìš©ì ID */
      let distinctId = localStorage.getItem("mixpanel_distinct_id");
      if (!distinctId) {
        distinctId = crypto.randomUUID();
        localStorage.setItem("mixpanel_distinct_id", distinctId);
      }

      mixpanel.init("d7d8d6afc10a92f911ea59901164605b", {
        debug: true,
        autotrack: true,
        persistence: "localStorage",
      });
      mixpanel.identify(distinctId);

      mixpanel.track("ê´€ìƒ ê²°ì œ ì„±ê³µ í˜ì´ì§€ ì§„ì…", {
        url: location.href,
        ua: navigator.userAgent,
        ts: new Date().toISOString(),
      });
    </script>

    <!-- â”€â”€â”€â”€â”€ ê²°ì œ ê²€ì¦ & IndexedDB ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€ -->
    <script>
      /* 0. URL íŒŒë¼ë¯¸í„° */
      const qs = new URLSearchParams(location.search);
      const paymentKey = qs.get("paymentKey");
      const orderId = qs.get("orderId");
      const amount = Number(qs.get("amount"));
      const resultId = qs.get("id");
      const reportType = (qs.get("type") || "base").trim();

      /* 1. IndexedDB ìœ í‹¸ */
      function openDB() {
        return new Promise((res) => {
          const r = indexedDB.open("FaceAnalysisDB", 1);
          r.onsuccess = (e) => res(e.target.result);
        });
      }
      const ALL_TYPES = ["base", "wealth", "love", "marriage", "career"];
      function ensureSkeleton(rec) {
        if (!rec.reports) rec.reports = {};
        for (const t of ALL_TYPES)
          if (!rec.reports[t]) rec.reports[t] = { paid: false, data: null };
      }

      /* 2. paid = true í† ê¸€ */
      function markPaid(db, id, type = "base") {
        return new Promise((resolve, reject) => {
          const tx = db.transaction("results", "readwrite");
          const st = tx.objectStore("results");
          const g = st.get(id);
          g.onerror = reject;
          g.onsuccess = () => {
            const rec = g.result;
            if (!rec) {
              reject("ID not found");
              return;
            }
            ensureSkeleton(rec);
            rec.reports[type].paid = true;
            rec.reports[type].purchasedAt = new Date().toISOString();
            st.put(rec);
          };
          tx.oncomplete = () => resolve(true); /* commit ì™„ë£Œ */
          tx.onerror = reject;
        });
      }

      /* 3. ì„œë²„ ê²€ì¦ */
      fetch(
        "https://port-0-momzzi-fastapi-m7ynssht4601229b.sel4.cloudtype.app/payment/confirm",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentKey, orderId, amount }),
        }
      )
        .then((r) => {
          if (!r.ok) throw new Error("ì„œë²„ ê²€ì¦ ì‹¤íŒ¨");
          return r.json();
        })
        .then(async () => {
          document.getElementById("status").textContent =
            "âœ… ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!";
          document.getElementById("status").className = "success";

          mixpanel.track("ê´€ìƒ ê²°ì œ ì„±ê³µ", {
            orderId,
            amount,
            paymentKey,
            resultId,
            reportType,
            ts: new Date().toISOString(),
          });

          if (resultId) {
            try {
              const db = await openDB();
              await markPaid(db, resultId, reportType); /* commit ë³´ì¥ */
              console.log("âœ… reports.%s.paid = true ì €ì¥", reportType);
            } catch (e) {
              console.error("IndexedDB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", e);
            }
          }

          setTimeout(() => {
            // â˜… ì—¬ê¸°!
            location.href = `/analyze-result/?id=${encodeURIComponent(
              resultId
            )}&type=${encodeURIComponent(reportType)}`;
          }, 2000);
        })
        .catch((err) => {
          console.error("âŒ ê²°ì œ í™•ì¸ ì‹¤íŒ¨", err);
          document.getElementById("status").textContent =
            "âŒ ê²°ì œ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
          document.getElementById("status").className = "fail";
          mixpanel.track("ê´€ìƒ ê²°ì œ ì‹¤íŒ¨", {
            error: err.message,
            orderId,
            amount,
            paymentKey,
            resultId,
            ts: new Date().toISOString(),
          });
          setTimeout(() => (location.href = "/fail.html"), 2500);
        });
    </script>
  </body>
</html>
<!-- 



1. [ì½”ì™€ ì½§ëŒ€] í†µì¥ì´ ìµœê³ ì  ì°ì„ í•´
2. [ì´ë§ˆì™€ ëˆˆì¹] ì²« ëŒ€ë°• í„°ì§ˆ ë‚˜ì´
3. [ëˆˆê³¼ ëˆˆë§¤] ëŒë¦¬ëŠ” ì´ìƒí˜• ë³¸ëŠ¥ ì½”ë“œ
4. [ì…ê³¼ ì…ìˆ ] ê±°ì ˆ ëª» í•  ì„¤ë“ íƒ€ìœ¨
5. [í„±ê³¼ ê´‘ëŒ€] ì€í‡´ í›„ ë°˜ê²© ëª¨ë¨¼íŠ¸
6. [ì–¼êµ´í˜•] ì¸ìƒ ê·¸ë˜í”„ ìƒìŠ¹ ê°ë„
7. [ì „ì²´ ì¸ìƒÂ·ê¸°ìš´] ë¡œë˜ê¸‰ ê¹œì§ í–‰ìš´ ì§€ìˆ˜
8. [ìš´ëª…Â·ê²½ë¡œ] ì¸ìƒ ë°˜ì „ ë²„íŠ¼ ì‘ë™ ì‹œì 
9. [ëŒ€ì¸ ê´€ê³„Â·ì¸ì—°] ê·€ì¸ ë§Œë‚  ë‹¬ë ¥ í‘œì‹œ
10. [ì¢…í•© ê²°ë¡ ] ê¸¸Â·í‰ ì´í•© ìŠ¹ë¶€ìˆ˜ í•œì¤„

-- 1. [ë¶€ìœ„ë³„ ì‹¬ì¸µ ê´€ìƒ]
2. [íƒ€ê³ ë‚œ ì¸ì—°]
<span class="mask-text-span-love">ì´ ì—°ì•  íšŸìˆ˜ & ì‚¬ë‘ ì‚¬ì´í´</span><br />
3. [ìš´ëª… ìƒëŒ€ ì§€ë„] <span class="mask-text-span-love">ì‹œÂ·êµ¬ ë‹¨ìœ„ ìœ„ì¹˜ ì˜ˆì¸¡</span
><br />
4. [ë§Œë‚¨ ì˜¤í”ˆ íƒ€ì´ë°]
<span class="mask-text-span-love">ê³„ì ˆÂ·ì¥ì†Œ & ê°œìš´ í–‰ë™</span><br />
5. [ì´ìƒì  ìƒëŒ€] <span class="mask-text-span-love">ëŒì–´ë‹¹ê¹€ ì „ëµ</span><br />
6. [ì—°ì•  ì„±í–¥ ë¶„ì„] <span class="mask-text-span-love">ê°•Â·ì•½ì  & ë³´ì™„ë²•</span
><br />
7. [ì§€ì†ë ¥ ì—…ê·¸ë ˆì´ë“œ]
<span class="mask-text-span-love">ì˜¤ë˜ ê°€ëŠ” ì‚¬ë‘ ë¹„ê²°</span><br />
8. [ê°œìš´ ì²´í¬ë¦¬ìŠ¤íŠ¸] <span class="mask-text-span-love">ì—°ì•  ìš´ ìƒìŠ¹ ì‹¤ì²œí‘œ</span
><br />

><br />
2. [íƒ€ê³ ë‚œ ë¶€ì™€ í‰ìƒ ëª¨ì„ ì¬ì‚°]
<span class="mask-text-span"> ë‚´ í‰ìƒ ìì‚° ê·œëª¨</span><br />
3. [ì„±í–¥ê³¼ ì¬ë¬¼ìš´ì˜ ê°•Â·ì•½ì ]
<span class="mask-text-span"> ëˆê³¼ ë§Œë‚˜ëŠ” ì§€ì </span><br />
4. [ëˆì´ ë¶™ëŠ” ì ì„±ê³¼ í™˜ê²½]
<span class="mask-text-span"> ë¶€ë¥¼ ìœ„í•œ ì¼Â·ì‚¬ëŒÂ·ì¥ì†Œ</span><br />
5. [ìì‚°ì„ í‚¤ìš¸ ê³¨ë“ íƒ€ì„]
<span class="mask-text-span"> ì‹œê¸°ë³„ ê¸°íšŒ í¬ì°© ì „ëµ</span><br />
6. [ìœ„ê¸° ì§•ì¡°ì™€ ì˜ˆë°©ì±…]
<span class="mask-text-span"> ì†ì¬Â·íˆ¬ì ë¦¬ìŠ¤í¬ ëŒ€ë¹„</span><br />
7. [ê´€ìƒ ê°œì„  ì‹¤ì²œë²•]
<span class="mask-text-span"> ì‘ì€ ìŠµê´€ìœ¼ë¡œ ê¸°ìš´ íŠ¸ì´ê¸°</span><br />
8. [ê´€ìƒê°€ ì–‘ë°˜ì˜ ì¸ìƒ ì¡°ì–¸]
<span class="mask-text-span"> ëˆ ê·¸ ì´ìƒ ì‚¶ì˜ íƒœë„</span><br />


2. [ì—°ì•  ì„±í–¥Â·ê²°í˜¼ê´€]
<span class="mask-text-span-marriage">ì• ì • í‘œí˜„â€§ê°€ì¹˜ê´€ ë¶„ì„</span><br />
3. [ê³¨ë“ íƒ€ì„] <span class="mask-text-span-marriage">ë§Œë‚¨ ì‹œê¸°Â·ì¥ì†ŒÂ·ê°œìš´ë²•</span
><br />
4. [ì´ìƒì  ë°°ìš°ì]
<span class="mask-text-span-marriage">ì™¸ëª¨Â·ì„±ê²©Â·ì²« ëŒ€í™” ì˜¤í”„ë„ˆ</span><br />
5. [ê²°í˜¼ ìƒí™œ ì‹œë®¬]
<span class="mask-text-span-marriage">ê²½ì œÂ·ì†Œí†µÂ·ìë…€ ìš´</span><br />
6. [ê°œìš´ ì²´í¬ë¦¬ìŠ¤íŠ¸]
<span class="mask-text-span-marriage">ì¸ì—° ë¶€ë¥´ëŠ” ë°ì¼ë¦¬ ë£¨í‹´</span><br />

1. [ë¶€ìœ„ë³„ ì‹¬ì¸µ ê´€ìƒ]
<span class="mask-text-span-career">5,000ì ë³´ê³ ì„œ í¬í•¨</span><br />

2. [ì ì„±ê³¼ ì¥ë‹¨ì ] <span class="mask-text-span-career">ì²œì§ ì°¾ëŠ” DNA ë¶„ì„</span
><br />

3. [ì§ì—… ìš´ ê³¡ì„ ] <span class="mask-text-span-career">ì»¤ë¦¬ì–´ ê½ƒ í”¼ëŠ” ì‹œê¸°</span
><br />

4. [ê°•ì  ê·¹ëŒ€í™” ì „ëµ]
<span class="mask-text-span-career">ì„±í–¥ë³„ ì¼ ì˜í•˜ëŠ” ë£¨í‹´</span><br />

5. [ì§ì¥ vs ì°½ì—…]
<span class="mask-text-span-career">ì„±ê³µ í™•ë¥ Â·ì í•©ë„ ë¹„êµ</span><br />

6. [í–‰ìš´ì˜ ì—…ë¬´ í™˜ê²½]
<span class="mask-text-span-career">ëˆÂ·ì‚¬ëŒÂ·ê³µê°„ ê¸°ìš´ í¬ì¸íŠ¸</span><br />

7. [ìœ„ê¸° ëŒ€ë¹„ ì²´í¬]
<span class="mask-text-span-career">ë²ˆì•„ì›ƒÂ·ë¦¬ìŠ¤í¬ ì˜ˆë°©ë²•</span><br />

8. [ê´€ìƒ ê°œì„  ì‹¤ì²œë²•]
<span class="mask-text-span-career">ì»¤ë¦¬ì–´ ìš´ íŠ¸ì´ëŠ” ìŠµê´€</span><br /> -->
