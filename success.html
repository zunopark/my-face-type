<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>결제 성공</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 40px;
      }
      .success {
        font-size: 20px;
        color: green;
      }
      .fail {
        font-size: 20px;
        color: red;
      }
    </style>
  </head>
  <body>
    <h2 id="status">🔄 결제 확인 중...</h2>
    <p>잠시만 기다려주세요.</p>

    <script>
      const params = new URLSearchParams(window.location.search);
      const paymentKey = params.get("paymentKey");
      const orderId = params.get("orderId");
      const amount = Number(params.get("amount"));
      const resultId = params.get("id");

      const body = { paymentKey, orderId, amount };

      // ✅ IndexedDB 초기화
      async function initDB() {
        const request = indexedDB.open("FaceAnalysisDB", 1);

        request.onupgradeneeded = function (event) {
          db = event.target.result;
          if (!db.objectStoreNames.contains("results")) {
            const store = db.createObjectStore("results", { keyPath: "id" });
            store.createIndex("timestamp", "timestamp", { unique: false });
          }
        };

        request.onsuccess = function (event) {
          db = event.target.result;
          console.log("✅ IndexedDB 초기화 완료");
        };

        request.onerror = function (event) {
          console.error("❌ IndexedDB 오류", event);
        };
      }

      // ✅ 특정 ID의 paid를 true로 변경
      async function markPaid(db, id) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(["results"], "readwrite");
          const store = transaction.objectStore("results");
          const getRequest = store.get(id);

          getRequest.onsuccess = () => {
            const data = getRequest.result;
            if (data) {
              data.paid = true;
              const putRequest = store.put(data);
              putRequest.onsuccess = () => resolve(true);
              putRequest.onerror = reject;
            } else {
              reject("❌ 해당 ID의 결과 없음");
            }
          };

          getRequest.onerror = reject;
        });
      }

      fetch(
        "https://port-0-momzzi-fastapi-m7ynssht4601229b.sel4.cloudtype.app/payment/confirm",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        }
      )
        .then((res) => {
          if (!res.ok) throw new Error("서버 검증 실패");
          return res.json();
        })
        .then(async (data) => {
          console.log("✅ 결제 확인 완료", data);
          document.getElementById("status").textContent =
            "✅ 결제가 완료되었습니다!";
          document.getElementById("status").className = "success";

          if (resultId) {
            try {
              const db = await initDB();
              await markPaid(db, resultId);
              console.log("✅ IndexedDB 결제 상태 업데이트 완료");
            } catch (e) {
              console.error("❌ IndexedDB 업데이트 실패:", e);
            }
          }

          setTimeout(() => {
            window.location.href = resultId
              ? `/result.html?id=${resultId}`
              : "/";
          }, 2000);
        })
        .catch((err) => {
          console.error("❌ 결제 확인 실패", err);
          document.getElementById("status").textContent =
            "❌ 결제 확인에 실패했습니다.";
          document.getElementById("status").className = "fail";

          setTimeout(() => {
            window.location.href = "/fail.html";
          }, 3000);
        });
    </script>
  </body>
</html>
