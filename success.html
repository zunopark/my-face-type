<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ê²°ì œ ì„±ê³µ</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 40px;
      }
      .success {
        font-size: 20px;
        color: green;
      }
      .fail {
        font-size: 20px;
        color: red;
      }
    </style>
  </head>
  <body>
    <h2 id="status">ğŸ”„ ê²°ì œ í™•ì¸ ì¤‘...</h2>
    <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>

    <script>
      const params = new URLSearchParams(window.location.search);
      const paymentKey = params.get("paymentKey");
      const orderId = params.get("orderId");
      const amount = Number(params.get("amount"));
      const resultId = params.get("id");

      const body = { paymentKey, orderId, amount };

      // âœ… IndexedDB ì´ˆê¸°í™”
      async function initDB() {
        const request = indexedDB.open("FaceAnalysisDB", 1);

        request.onupgradeneeded = function (event) {
          db = event.target.result;
          if (!db.objectStoreNames.contains("results")) {
            const store = db.createObjectStore("results", { keyPath: "id" });
            store.createIndex("timestamp", "timestamp", { unique: false });
          }
        };

        request.onsuccess = function (event) {
          db = event.target.result;
          console.log("âœ… IndexedDB ì´ˆê¸°í™” ì™„ë£Œ");
        };

        request.onerror = function (event) {
          console.error("âŒ IndexedDB ì˜¤ë¥˜", event);
        };
      }

      // âœ… íŠ¹ì • IDì˜ paidë¥¼ trueë¡œ ë³€ê²½
      async function markPaid(db, id) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(["results"], "readwrite");
          const store = transaction.objectStore("results");
          const getRequest = store.get(id);

          getRequest.onsuccess = () => {
            const data = getRequest.result;
            if (data) {
              data.paid = true;
              const putRequest = store.put(data);
              putRequest.onsuccess = () => resolve(true);
              putRequest.onerror = reject;
            } else {
              reject("âŒ í•´ë‹¹ IDì˜ ê²°ê³¼ ì—†ìŒ");
            }
          };

          getRequest.onerror = reject;
        });
      }

      fetch(
        "https://port-0-momzzi-fastapi-m7ynssht4601229b.sel4.cloudtype.app/payment/confirm",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        }
      )
        .then((res) => {
          if (!res.ok) throw new Error("ì„œë²„ ê²€ì¦ ì‹¤íŒ¨");
          return res.json();
        })
        .then(async (data) => {
          console.log("âœ… ê²°ì œ í™•ì¸ ì™„ë£Œ", data);
          document.getElementById("status").textContent =
            "âœ… ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!";
          document.getElementById("status").className = "success";

          if (resultId) {
            try {
              const db = await initDB();
              await markPaid(db, resultId);
              console.log("âœ… IndexedDB ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
            } catch (e) {
              console.error("âŒ IndexedDB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", e);
            }
          }

          setTimeout(() => {
            window.location.href = resultId
              ? `/result.html?id=${resultId}`
              : "/";
          }, 2000);
        })
        .catch((err) => {
          console.error("âŒ ê²°ì œ í™•ì¸ ì‹¤íŒ¨", err);
          document.getElementById("status").textContent =
            "âŒ ê²°ì œ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
          document.getElementById("status").className = "fail";

          setTimeout(() => {
            window.location.href = "/fail.html";
          }, 3000);
        });
    </script>
  </body>
</html>
