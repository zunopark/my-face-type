<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ê²°ì œ ì„±ê³µ</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 40px;
      }
      .success {
        font-size: 20px;
        color: green;
      }
      .fail {
        font-size: 20px;
        color: red;
      }
      #retryBtn {
        margin-top: 24px;
        padding: 10px 16px;
        font-size: 16px;
        display: none; /* ì²« í™”ë©´ì—” ìˆ¨ê¹€ */
        cursor: pointer;
      }
    </style>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ Mixpanel JS Stub (ê³µì‹) â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <script type="text/javascript">
      /* â†“â†“â†“ Mixpanel ë¯¸ë‹ˆ SDK â€“ ì›ë³¸ ê·¸ëŒ€ë¡œ (ìƒëµ ì—†ìŒ) â†“â†“â†“ */
      (function (f, b) {
        if (!b.__SV) {
          var e, g, i, h;
          window.mixpanel = b;
          b._i = [];
          b.init = function (e, f, c) {
            function g(a, d) {
              var b = d.split(".");
              2 == b.length && ((a = a[b[0]]), (d = b[1]));
              a[d] = function () {
                a.push([d].concat(Array.prototype.slice.call(arguments, 0)));
              };
            }
            var a = b;
            "undefined" !== typeof c ? (a = b[c] = []) : (c = "mixpanel");
            a.people = a.people || [];
            a.toString = function (a) {
              var d = "mixpanel";
              "mixpanel" !== c && (d += "." + c);
              a || (d += " (stub)");
              return d;
            };
            a.people.toString = function () {
              return a.toString(1) + ".people (stub)";
            };
            i =
              "disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(
                " "
              );
            for (h = 0; h < i.length; h++) g(a, i[h]);
            var j = "set set_once union unset remove delete".split(" ");
            a.get_group = function () {
              function b(c) {
                d[c] = function () {
                  call2_args = arguments;
                  call2 = [c].concat(Array.prototype.slice.call(call2_args, 0));
                  a.push([e, call2]);
                };
              }
              for (
                var d = {},
                  e = ["get_group"].concat(
                    Array.prototype.slice.call(arguments, 0)
                  ),
                  c = 0;
                c < j.length;
                c++
              )
                b(j[c]);
              return d;
            };
            b._i.push([e, f, c]);
          };
          b.__SV = 1.2;
          e = f.createElement("script");
          e.type = "text/javascript";
          e.async = !0;
          e.src =
            "undefined" !== typeof MIXPANEL_CUSTOM_LIB_URL
              ? MIXPANEL_CUSTOM_LIB_URL
              : "file:" === f.location.protocol &&
                "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)
              ? "https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js"
              : "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";
          g = f.getElementsByTagName("script")[0];
          g.parentNode.insertBefore(e, g);
        }
      })(document, window.mixpanel || []);
      /* â†‘â†‘â†‘ Mixpanel ë¯¸ë‹ˆ SDK â€“ ì›ë³¸ ë â†‘â†‘â†‘ */
    </script>
  </head>

  <body>
    <h2 id="status">ğŸ”„ ê²°ì œ í™•ì¸ ì¤‘...</h2>
    <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    <button id="retryBtn">ë‹¤ì‹œ ì‹œë„</button>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ Mixpanel ì´ˆê¸°í™” & ì²« ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <script>
      /* ê³ ìœ  ì‚¬ìš©ì ID í™•ë³´ (localStorage ë³´ì¡´) */
      let distinctId = localStorage.getItem("mixpanel_distinct_id");
      if (!distinctId) {
        distinctId = crypto.randomUUID();
        localStorage.setItem("mixpanel_distinct_id", distinctId);
      }

      mixpanel.init("d7d8d6afc10a92f911ea59901164605b", {
        debug: true,
        autotrack: true,
        persistence: "localStorage",
      });
      mixpanel.identify(distinctId);

      mixpanel.track("ê´€ìƒ ê²°ì œ ì„±ê³µ í˜ì´ì§€ ì§„ì…", {
        url: location.href,
        ua: navigator.userAgent,
        ts: new Date().toISOString(),
      });
    </script>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê²°ì œ ê²€ì¦ & IndexedDB ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <script>
      /* â”€â”€â”€ 0) URL íŒŒë¼ë¯¸í„° â”€â”€â”€ */
      const qs = new URLSearchParams(location.search);
      const paymentKey = qs.get("paymentKey"); // Toss Payments
      const orderId = qs.get("orderId");
      const amount = Number(qs.get("amount"));
      const resultId = qs.get("id");
      const reportType = (qs.get("type") || "base").trim(); // baseÂ·wealthÂ·loveÂ·â€¦ or couple

      /* â”€â”€â”€ 1) IndexedDB ìœ í‹¸ â”€â”€â”€ */
      function openDB(dbName) {
        return new Promise((res, rej) => {
          const r = indexedDB.open(dbName, 1);
          r.onerror = () => rej(r.error);
          r.onsuccess = (e) => res(e.target.result);
        });
      }

      const ALL_TYPES = ["base", "wealth", "love", "marriage", "career"];
      function ensureSkeleton(rec, type) {
        if (!rec.reports) rec.reports = {};
        if (type === "couple") {
          if (!rec.reports.couple)
            rec.reports.couple = { paid: false, data: null };
        } else {
          for (const t of ALL_TYPES)
            if (!rec.reports[t]) rec.reports[t] = { paid: false, data: null };
        }
      }

      function markPaid(db, id, type = "base") {
        return new Promise((resolve, reject) => {
          const tx = db.transaction("results", "readwrite");
          const store = tx.objectStore("results");
          const get = store.get(id);
          get.onerror = reject;
          get.onsuccess = () => {
            const rec = get.result;
            if (!rec) return reject("ID not found");
            ensureSkeleton(rec, type);
            const now = new Date().toISOString();
            if (type === "couple") {
              rec.reports.couple.paid = true;
              rec.reports.couple.purchasedAt = now;
            } else {
              rec.reports[type].paid = true;
              rec.reports[type].purchasedAt = now;
            }
            store.put(rec);
          };
          tx.oncomplete = () => resolve(true);
          tx.onerror = reject;
        });
      }

      /* â”€â”€â”€ 2) fetch íƒ€ì„ì•„ì›ƒ ë˜í¼ â”€â”€â”€ */
      function fetchWithTimeout(url, opts = {}, ms = 8000) {
        return Promise.race([
          fetch(url, opts),
          new Promise((_, rej) =>
            setTimeout(() => rej(new Error("TIMEOUT")), ms)
          ),
        ]);
      }

      /* â”€â”€â”€ 3) ìƒíƒœ ë¬¸êµ¬ ìŠ¤í”¼ë„ˆ â”€â”€â”€ */
      const statusEl = document.getElementById("status");
      const tips = [
        "ğŸ”„ ê²°ì œ í™•ì¸ ì¤‘...",
        "â³ ì„œë²„ ì‘ë‹µ ëŒ€ê¸°...",
        "ğŸ“¡ ë„¤íŠ¸ì›Œí¬ ì¬ì‹œë„ ì¤€ë¹„...",
      ];
      let tipIdx = 0;
      const spinner = setInterval(() => {
        tipIdx = (tipIdx + 1) % tips.length;
        statusEl.textContent = tips[tipIdx];
      }, 10000);

      /* â”€â”€â”€ 4) ê²€ì¦ â†’ ì„±ê³µ/ì‹¤íŒ¨ íë¦„ â”€â”€â”€ */
      const MAX_RETRY = 3;
      const BASE_DELAY = 1500; // 1.5s â†’ 3s â†’ 6s

      async function confirmPayment(attempt = 1) {
        try {
          const res = await fetchWithTimeout(
            "https://port-0-momzzi-fastapi-m7ynssht4601229b.sel4.cloudtype.app/payment/confirm",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentKey, orderId, amount }),
            },
            8000
          );

          /* ì„œë²„ HTTP ì˜¤ë¥˜ â†’ catch ì²˜ë¦¬ */
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          /* JSON íŒŒì‹± (í•„ìš” ì‹œ ì‚¬ìš©) */
          await res.json();

          /* â”€â”€ ì„±ê³µ ë¡œì§ â”€â”€ */
          clearInterval(spinner);
          statusEl.textContent = "âœ… ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!";
          statusEl.className = "success";

          mixpanel.track("ê´€ìƒ ê²°ì œ ì„±ê³µ", {
            orderId,
            amount,
            paymentKey,
            resultId,
            reportType,
            ts: new Date().toISOString(),
          });

          if (resultId) {
            try {
              const dbName =
                reportType === "couple" ? "CoupleAnalysisDB" : "FaceAnalysisDB";
              const db = await openDB(dbName);
              await markPaid(db, resultId, reportType);
              console.log(`âœ… ${reportType}.paid = true ì €ì¥ ì™„ë£Œ`);
            } catch (e) {
              console.error("âŒ IndexedDB ì €ì¥ ì‹¤íŒ¨:", e);
            }
          }

          /* 2ì´ˆ í›„ ë³´ê³ ì„œë¡œ ì´ë™ */
          setTimeout(() => {
            const url =
              reportType === "couple"
                ? `/couple-report/?id=${encodeURIComponent(resultId)}`
                : `/analyze-result/?id=${encodeURIComponent(
                    resultId
                  )}&type=${encodeURIComponent(reportType)}`;
            location.href = url;
          }, 2000);
        } catch (err) {
          console.warn(`âš ï¸  [${attempt}] í™•ì¸ ì‹¤íŒ¨:`, err.message);

          /* ì¬ì‹œë„ ê°€ëŠ¥ */
          if (attempt < MAX_RETRY) {
            statusEl.textContent = `ğŸ”„ ì¬ì‹œë„ ${attempt}/${MAX_RETRY}â€¦`;
            const delay = BASE_DELAY * 2 ** (attempt - 1); // 1.5s â†’ 3s â†’ 6s
            setTimeout(() => confirmPayment(attempt + 1), delay);
          } else {
            /* â”€â”€ ìµœì¢… ì‹¤íŒ¨ â”€â”€ */
            clearInterval(spinner);
            statusEl.textContent = "âŒ ê²°ì œ í™•ì¸ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
            statusEl.className = "fail";

            mixpanel.track("ê´€ìƒ ê²°ì œ ì‹¤íŒ¨", {
              error: err.message,
              orderId,
              amount,
              paymentKey,
              resultId,
              ts: new Date().toISOString(),
            });

            /* â€œë‹¤ì‹œ ì‹œë„â€ ë²„íŠ¼ ë…¸ì¶œ */
            retryBtn.style.display = "inline-block";
          }
        }
      }

      /* â”€â”€â”€ 5) ìˆ˜ë™ ì¬ì‹œë„ ë²„íŠ¼ â”€â”€â”€ */
      const retryBtn = document.getElementById("retryBtn");
      retryBtn.addEventListener("click", () => {
        retryBtn.style.display = "none";
        statusEl.textContent = "ğŸ”„ ê²°ì œ í™•ì¸ ì¬ì‹œë„ ì¤‘...";
        statusEl.className = "";
        confirmPayment(); // ì‹œë„ ì¹´ìš´íŠ¸ 1ë¶€í„° ë‹¤ì‹œ
      });

      /* â”€â”€â”€ 6) ì²« í˜¸ì¶œ â”€â”€â”€ */
      confirmPayment();
    </script>
  </body>
</html>
