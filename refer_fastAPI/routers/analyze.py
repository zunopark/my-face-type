from fastapi import APIRouter, File, UploadFile
import base64, requests
import re, textwrap, httpx, os
from utils.resize import resize_image
from pydantic import BaseModel
from typing import Dict, List

router = APIRouter()

from openai import OpenAI

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
GEMINI_API_URL = f"https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key={GEMINI_API_KEY}"

class FeatureRequest(BaseModel):
    feature: str  # 프론트에서 받은 얼굴 특징 전체

@router.post("/face-teller2/")
async def analyze_image(file: UploadFile = File(...)):
    try:
        content = await file.read()
        b64_image = await resize_image(content)

        headers = {"Content-Type": "application/json"}

        async with httpx.AsyncClient(timeout=60.0) as client:

            # Step 1: 특징 추출
            prompt_feature = {
                "contents": [
                    {
                        "parts": [
                            {"text": """
                                아래는 얼굴 특징 분석 요청입니다.

                                ### 1. 각 항목별로 사진에서 '겉으로 보이는 외형적 특징'만 한국어로 객관적으로 설명해 주세요.  
                                2. 절대 성격, 운세, 해석 등 주관적 해설은 하지 마세요. 오직 보이는 사실만 묘사해야 합니다.  
                                3. 반드시 항목별로 아래 예시 형식을 따라주세요.  
                                4. 아래 표의 분류/키워드 중 실제 해당하는 것은 빠짐없이 모두 기술하세요.  
                                5. 여러 특징이 동시에 보이면 모두 작성하세요.  
                                6. **얼굴 전체가 인식되지 않을 경우에만 'again'이라는 단어 하나만 출력하세요.**
                                - 일부 부위가 가려져도, 보이는 부위는 반드시 묘사하세요.
                                - 단, 얼굴이 전혀 인식되지 않거나 분석 불가 시에는 무조건 `again`만 출력.
                                7. **오관(눈·코·입·귀·눈썹), 삼정(상정·중정·하정), 12궁(각 부위의 모양·크기·위치·대칭 여부)을 반드시 포함해 설명하세요.**
                                8. 12궁 설명 시 각 부위의 형태, 크기, 위치, 대칭, 돌출·함몰 여부, 주름·점·흉터 유무, 길이/깊이 등 구체적으로 묘사하세요.

                                ---

                                ✅ 오관 (눈·코·입·귀·눈썹)  
                                👁️ 눈: 크기/형태(큰눈/작은눈/가느다란눈), 눈꼬리(올라감/처짐), 깊이(깊은눈/튀어나온눈), 쌍꺼풀 여부  
                                👃 코: 코날(우뚝/굽음), 높이(높음/낮음), 크기(크다/작다), 콧망울 형태, 콧대 두께  
                                👄 입: 크기(큰입/작은입), 입꼬리(올라감/처짐), 입술 두께(윗입술 두꺼움/아랫입술 두꺼움/얇음), 대칭 여부  
                                🪒 눈썹: 길이(긴/짧은), 두께(진한/엷은), 모양(일자/초승달/八자), 방향(치켜진/처진)  
                                👂 귀: 크기(크다/작다), 위치(위쪽/아래쪽), 귓볼(크다/작다/두껍다/얇다), 귀 각도(앞으로/뒤로 젖혀짐)

                                ---

                                ✅ 삼정  
                                - **상정(이마~눈썹)**: 이마 높이, 너비, 주름, 모양(둥근/네모진/M자형), 피부 표면  
                                - **중정(눈~코~광대)**: 광대 발달 정도, 코 크기와 높이, 코끝 모양, 비대칭 여부  
                                - **하정(코끝~턱)**: 입 모양, 턱 길이, 턱선 각도, 돌출/후퇴 여부

                                ---

                                ✅ 12궁 (사진에서 확인 가능한 외형 기준)  
                                1. **관록궁(이마)** → 넓이, 높이, 형태(둥근/네모/튀어나옴), 주름·흉터 여부  
                                2. **인당궁(미간)** → 너비, 평탄함/패임, 주름·점 유무  
                                3. **자녀궁(눈)** → 크기, 모양, 쌍꺼풀 유무, 대칭 여부  
                                4. **부부궁(광대)** → 크기, 높이, 폭, 돌출/함몰, 대칭 여부  
                                5. **재물궁(코)** → 길이, 폭, 콧대 모양, 콧망울 크기  
                                6. **수명궁(인중)** → 길이(짧음/김), 깊이(깊음/얕음), 대칭 여부, 주름·점 유무  
                                7. **노복궁(입)** → 크기, 폭, 입꼬리 방향, 대칭 여부  
                                8. **지궁(턱)** → 길이, 폭, 각도, 돌출/후퇴 여부, 좌우 균형  
                                9. **법령궁(법령)** → 주름 선명도, 길이, 대칭 여부  
                                10. **부모궁(귀)** → 크기, 위치, 형태, 귓볼 크기, 귓바퀴 두께  
                                11. **형제궁(뺨)** → 폭, 볼살 유무, 대칭 여부  
                                12. **관골궁(관골)** → 높이, 돌출/함몰, 폭, 대칭 여부

                                ---

                                **최종 출력 예시**  
                                눈은 크고 쌍꺼풀이 있으며 눈꼬리가 약간 올라가 있고 깊은 눈입니다.  
                                코는 코날이 곧고 높으며, 콧망울이 넓습니다.  
                                입은 작고 양쪽 입꼬리가 올라가 있으며, 윗입술이 두껍습니다.  
                                이마는 넓고 둥글며 중앙에 얕은 가로주름이 있습니다.  
                                눈썹은 길고 진하며 일자 모양입니다.  
                                귀는 크고 귓볼이 두껍고, 위치가 얼굴 중간보다 조금 높습니다.  
                                턱은 짧고 각지며 약간 앞으로 돌출되어 있습니다.  
                                광대는 넓고 약간 발달했습니다.

                                12궁 부위:  
                                - 관록궁(이마): 넓고 매끈함  
                                - 인당궁(미간): 넓고 평탄함  
                                - 자녀궁(눈): 대칭, 크고 또렷함  
                                - 부부궁(광대): 좌우 균형, 적당히 발달  
                                - 재물궁(코): 높고 곧음  
                                - 수명궁(인중): 길고 깊음  
                                - 노복궁(입): 폭 좁고 입꼬리 상승  
                                - 지궁(턱): 각지고 돌출  
                                - 법령궁(법령): 얕고 짧음  
                                - 부모궁(귀): 귓볼 큼, 위치 위쪽  
                                - 형제궁(뺨): 폭 좁음, 볼살 적음  
                                - 관골궁(관골): 돌출, 폭 넓음

                                성별: 남자

                                **예외 예시 (얼굴 자체가 인식되지 않는 경우)**  
                                again
                            """
                            
                            },  # 생략된 지시문 넣기
                            {"inline_data": {"mime_type": "image/jpeg", "data": b64_image}}
                        ]
                    }
                ]
            }

            feature_res = await client.post(GEMINI_API_URL, headers=headers, json=prompt_feature)
            feature_res.raise_for_status()
            features = feature_res.json()["candidates"][0]["content"]["parts"][0]["text"]

            # Step 3: 상세  보고서
            with open("face_report_prompt.txt", "r", encoding="utf-8") as f:
                base_guide = f.read()

            prompt_detail = {
                "contents": [
                    {"parts": [{"text": f"""
                        유저 얼굴 특징: {features}

                        아래는 전통 한국 관상 해석 참고 가이드입니다. 반드시 이 내용을 바탕으로 해석하세요.  
                        {base_guide}

                        ────────────────────────────────────────
                        ✍️ **작성·출력 규칙**

                        1. **총 분량**: 15,000±300자(공백 포함)  
                        - 다섯 항목을 다음 비율로 분배  
                            | 항목 | 목표 글자 수(±5%) | 필수 구성 요소 |
                            |------|------------------|---------------|
                            | 1. 부위별 관상 | **3,500자** | 오관·삼정·12궁 결과, 연계 해석, 천기누설 |
                            | 2. 연애운 | **3,000자** | 인연 총량·타이밍·매력·상대 상성, 천기누설 |
                            | 3. 직업운 | **3,000자** | 재능·장단점·커리어 곡선·직장/창업 비교, 천기누설 |
                            | 4. 재물운 | **2,500자** | 평생 자산 시나리오·강약점·돈 붙는 환경, 천기누설 |
                            | 5. 건강운 | **2,500자** | 체질·약점·건강 곡선·위기 구간, 천기누설 |

                        2. **형식**: 마크다운  
                        - 1단계 제목 `##`, 2단계 소제목 `###`  
                        - 하위 번호는 `**1.**`·`**2.**`처럼 굵은 숫자  
                        - 인용 박스: `> **TIP** …`, `> *경고* …`

                        3. **화법**  
                        - 화자는 ‘관상가 선생님’, 독자는 **“그대”**  
                        - **긍정 70 % / 개선 30 %** 비율  
                        - 단호·친근·권위 있는 어조

                        4. **가독성 장치**  
                        - 핵심 연·월·금액·퍼센트 → **굵게**  
                        - 위험·주의 → *밑줄*  
                        - 한자·전문어 직후 (간단 한글 풀이)  
                        - 표·리스트 자유 활용

                        5. **금기 사항**  
                        - 잡담·광고·요청 외 주제 금지
                        - 대답하는 내용 절대 금지
                        - 요청한 보고서 내용만 답변할 것
                        - 한글 외 언어 남용 금지, 필요한 경우 괄호 풀이만 허용

                        ** 반드시 글자 수를 지켜주세요. 총 15,000자 보고서를 발행해야합니다. 

                        ────────────────────────────────────────
                        ### 🔍 섹션별 세부 작성 가이드

                        | 항목 | 필요 문단 | 꼭 포함할 세부 내용 |
                        |------|-----------|--------------------|
                        | **1. 부위별 관상** | 4~5문단 | • **오관**: 각 부위별 장·단점, 다섯 관리(官) 협업도<br>• **삼정**: 상·중·하정 길이·흉터·광택이 주는 초·중·말년 변곡점<br>• **12궁**: 12궁별 길흉 + 궁 간 상호작용 예시 1~2개<br>• **종합 진단**: 균형·불균형이 삶에 미칠 영향<br>• **천기누설**: 시술·이미지 개선 포인트 2~3가지 |
                        | **2. 연애운** | 4문단 | • **연애 총량·주기**: 예상 횟수, 쉬는 주기 그래프 언급<br>• **타이밍**: 계절·장소·상황별 만남 확률과 이유<br>• **매력 포인트**: 도화살 위치, 19금 색기 지수, 활용 팁<br>• **이상적 상대**: 얼굴형·눈빛·성격 3가지 키워드<br>• **천기누설**: 인연이 살 지역·생활권 힌트 |
                        | **3. 직업운** | 4문단 | • **재능·장단점**: 상정·코·귀색과 일치하는 직능 분석<br>• **커리어 곡선**: 20‧30‧40‧50대별 성장/정체 구간<br>• **직장 vs 창업 비교**: 성공률·리스크·수익 구조 표<br>• **천기누설**: 최적 업종·부서, 연봉 피크 예측 연도 |
                        | **4. 재물운** | 4문단 | • **평생 자산 시나리오**: 보수·중립·공격형 3케이스<br>• **재물운 강‧약점**: 코·광대·팔자주름 분석, 지출 경계선<br>• **돈 붙는 환경**: 업·사람·공간·시간대별 금전 흐름<br>• **천기누설**: 재복을 키울 관상 관리·타이밍 |
                        | **5. 건강운** | 4문단 | • **타고난 체질**: 장부(臟腑) 강·약, 피부·귀색 징후<br>• **만성질환 소인**: 예방 우선순위 3가지<br>• **건강 곡선**: 20·40·60세 전후 위기 및 회복 지표<br>• **천기누설**: 필수 검진 월·전통 요법·생활 루틴 |

                        ────────────────────────────────────────
                        ## 정통 심층 관상 보고서

                        ### 1. 부위별 관상 심층 풀이 
                        **1-1. 오관 분석** ― 눈·코·입·귀·눈썹을 통해 기질·재물·언변·수용력·인간관계를 종합해 성격 풀이  
                        **1-2. 삼정 분석** ― 이마·코·턱 세 구역으로 초년·중년·말년의 굴곡과 전환점 풀이  
                        **1-3. 12궁 분석** ― 얼굴 전체를 지도처럼 훑어 재물·관직·건강·인연까지 세부 운세 정밀 풀이  
                        > **TIP**: 오관·삼정·12궁 결과를 종합할 때는 ‘균형’ 여부를 최우선으로 판단하라.  
                        ++ **천기누설(天機漏洩)** ― 팔자 피는 관상 성형 및 시술 부위 추천  

                        ---

                        ### 2. 연애운 심층 풀이 
                        **2-1. 타고난 인연** ― 총 연애 횟수와 연애 주기 예측, 첫사랑 시기와 영향력 분석  
                        **2-2. 만남 오픈 타이밍** ― 연애 기운이 가장 강한 계절·장소·상황 안내  
                        **2-3. 매력 풀이** ― 얼굴에서 드러나는 도화살, 매력 포인트, 19금 색기 지수 해석  
                        **2-4. 이상적 상대** ― 관상 상성(相性)으로 본 최적의 배우자 얼굴형·기질 묘사  
                        ++ **천기누설(天機漏洩)** ― 현재 인연이 머무는 가능성 높은 시·구 위치 예측  

                        ---

                        ### 3. 직업운 심층 풀이
                        **3-1. 적성과 장단점** ― 연봉 상한가를 찍을 직업군과 그대의 핵심 재능‧약점 분석  
                        **3-2. 직업 운 곡선** ― 커리어가 꽃피는 결정적 시기, 멈칫하는 구간, 재도약 전략  
                        **3-3. 직장 vs 창업** ― 성공 확률·적합도·스트레스 지수·수익 구조 상세 비교  
                        ++ **천기누설(天機漏洩)** ― 연봉 그래프 최고점을 찍을 구체적 업종·부서 예측  

                        ---

                        ### 4. 재물운 심층 풀이
                        **4-1. 타고난 부와 평생 모을 재산** ― 조상 덕, 본인 재물운, 최대 누적 자산 시나리오  
                        **4-2. 성향과 재물운의 강·약점** ― 돈과 만나는 장소·사람·습관, 지출 경계선  
                        **4-3. 돈이 붙는 적성과 환경** ― 부를 증식시키는 직업·투자·인맥·생활 패턴  
                        ++ **천기누설(天機漏洩)** ― 진짜 대박이 열릴 인생 시기 및 관상 개선 포인트  

                        ---

                        ### 5. 건강운 심층 풀이
                        **5-1. 타고난 체질 & 약점 탐색** ― 얼굴 빛·피부결·귀색·목선으로 보는 장부 강약과 만성질환 소인  
                        **5-2. 건강 곡선 & 위기 구간** ― 20·40·60세 전후 ‘주의 기점’, 회복 탄력성, 장수 가능성  
                        ++ **천기누설(天機漏洩)** ― 반드시 건강 검진을 받아야 할 구체적 연·월, 예방·회복 핵심 처방  
                    
                    """}]}
                ]
            }

             
            #          
            detail_res = await client.post(GEMINI_API_URL, headers=headers, json=prompt_detail)
            detail_res.raise_for_status()
            detail = detail_res.json()["candidates"][0]["content"]["parts"][0]["text"]

            # Step 2: 요약
            prompt_summary = {
                "contents": [
                    {"parts": [{"text": f"""
                            {detail}

                            위 내용은 사용자의 자세한 관상 풀이입니다. 위 내용을 기반으로 한 줄 관상을 알려주세요. 
                            요약은 교정 부위는 말해주지 말고, 재물 & 연애 & 인생에 관해서 한 두 줄로 요약해줘. 
                            "무슨 무슨 무슨 할 관상" 으로 요약해줘

                            이상한 잡다한 말과 대화법은 하지 말고 필요한 답변만 해주세요.

                            마지막에는 괄호 안에 100점 만점 기준의 관상 점수를 적어주세요. 점수는 보통 70~100점 사이로 적어주세요.
                            [좋은 관상 같으면 점수를 높게 주고, 조심해야할게 많으면 낮게주세요.] 

                            관상 결과, 점수 말고는 앞뒤에 어떤 말도 하지마세요.
                            아래는 예시일 뿐 실제 관상 풀이 기반으로 요약해주세요. 부위 등 순서는 상관 없습니다.
                            
                            예시:
                            ## 한 줄 관상 및 점수
                            "결혼하면 잘 살 관상" (점수: 93.3점 / 100점)
                    """}]}
                ]
            }

            summary_res = await client.post(GEMINI_API_URL, headers=headers, json=prompt_summary)   
            summary_res.raise_for_status()
            summary = summary_res.json()["candidates"][0]["content"]["parts"][0]["text"]


        # 섹션별로 파싱
        sections = parse_detail_sections(detail)

        return {
            "summary": summary,
            "detail": detail,
            "sections": sections,
            "features": features
        }

    except Exception as e:
        return {"error": str(e)}


def parse_detail_sections(detail: str) -> dict:
    """detail 텍스트를 5개 섹션으로 파싱"""
    import re

    sections = {
        "face_reading": "",
        "love": "",
        "career": "",
        "wealth": "",
        "health": ""
    }

    # 섹션 구분 패턴 (### 1. 부위별, ### 2. 연애운 등)
    patterns = [
        (r'###\s*1\.?\s*부위별[^\n]*\n(.*?)(?=###\s*2\.?\s*연애운|$)', 'face_reading'),
        (r'###\s*2\.?\s*연애운[^\n]*\n(.*?)(?=###\s*3\.?\s*직업운|$)', 'love'),
        (r'###\s*3\.?\s*직업운[^\n]*\n(.*?)(?=###\s*4\.?\s*재물운|$)', 'career'),
        (r'###\s*4\.?\s*재물운[^\n]*\n(.*?)(?=###\s*5\.?\s*건강운|$)', 'wealth'),
        (r'###\s*5\.?\s*건강운[^\n]*\n(.*?)(?=$)', 'health'),
    ]

    for pattern, key in patterns:
        match = re.search(pattern, detail, re.DOTALL)
        if match:
            sections[key] = match.group(1).strip()

    return sections


@router.post("/analyze/")
async def analyze_image(file: UploadFile = File(...)):
    try:
        content = await file.read()
        b64_image = await resize_image(content)

        headers = {"Content-Type": "application/json"}

        async with httpx.AsyncClient(timeout=30.0) as client:

            # Step 1: 특징 추출
            prompt_feature = {
                "contents": [
                    {
                        "parts": [
                            {"text": """
                                아래는 얼굴 특징 분석 요청입니다.

                                ### 1. 각 항목별로 사진에서 '겉으로 보이는 외형적 특징'만 한국어로 객관적으로 설명해 주세요.  
                                2. 절대 성격, 운세, 해석 등 주관적 해설은 하지 마세요. 오직 보이는 사실만 묘사해야 합니다.  
                                3. 반드시 항목별로 아래 예시 형식을 따라주세요.  
                                4. 아래 표의 분류/키워드 중 실제 해당하는 것은 빠짐없이 모두 기술하세요.  
                                5. 여러 특징이 동시에 보이면 모두 작성하세요.  
                                6. **얼굴 전체가 인식되지 않을 경우에만 'again'이라는 단어 하나만 출력하세요.**
                                - 일부 부위가 가려져도, 보이는 부위는 반드시 묘사하세요.
                                - 단, 얼굴이 전혀 인식되지 않거나 분석 불가 시에는 무조건 `again`만 출력.
                                7. **오관(눈·코·입·귀·눈썹), 삼정(상정·중정·하정), 12궁(각 부위의 모양·크기·위치·대칭 여부)을 반드시 포함해 설명하세요.**
                                8. 12궁 설명 시 각 부위의 형태, 크기, 위치, 대칭, 돌출·함몰 여부, 주름·점·흉터 유무, 길이/깊이 등 구체적으로 묘사하세요.

                                ---

                                ✅ 오관 (눈·코·입·귀·눈썹)  
                                👁️ 눈: 크기/형태(큰눈/작은눈/가느다란눈), 눈꼬리(올라감/처짐), 깊이(깊은눈/튀어나온눈), 쌍꺼풀 여부  
                                👃 코: 코날(우뚝/굽음), 높이(높음/낮음), 크기(크다/작다), 콧망울 형태, 콧대 두께  
                                👄 입: 크기(큰입/작은입), 입꼬리(올라감/처짐), 입술 두께(윗입술 두꺼움/아랫입술 두꺼움/얇음), 대칭 여부  
                                🪒 눈썹: 길이(긴/짧은), 두께(진한/엷은), 모양(일자/초승달/八자), 방향(치켜진/처진)  
                                👂 귀: 크기(크다/작다), 위치(위쪽/아래쪽), 귓볼(크다/작다/두껍다/얇다), 귀 각도(앞으로/뒤로 젖혀짐)

                                ---

                                ✅ 삼정  
                                - **상정(이마~눈썹)**: 이마 높이, 너비, 주름, 모양(둥근/네모진/M자형), 피부 표면  
                                - **중정(눈~코~광대)**: 광대 발달 정도, 코 크기와 높이, 코끝 모양, 비대칭 여부  
                                - **하정(코끝~턱)**: 입 모양, 턱 길이, 턱선 각도, 돌출/후퇴 여부

                                ---

                                ✅ 12궁 (사진에서 확인 가능한 외형 기준)  
                                1. **관록궁(이마)** → 넓이, 높이, 형태(둥근/네모/튀어나옴), 주름·흉터 여부  
                                2. **인당궁(미간)** → 너비, 평탄함/패임, 주름·점 유무  
                                3. **자녀궁(눈)** → 크기, 모양, 쌍꺼풀 유무, 대칭 여부  
                                4. **부부궁(광대)** → 크기, 높이, 폭, 돌출/함몰, 대칭 여부  
                                5. **재물궁(코)** → 길이, 폭, 콧대 모양, 콧망울 크기  
                                6. **수명궁(인중)** → 길이(짧음/김), 깊이(깊음/얕음), 대칭 여부, 주름·점 유무  
                                7. **노복궁(입)** → 크기, 폭, 입꼬리 방향, 대칭 여부  
                                8. **지궁(턱)** → 길이, 폭, 각도, 돌출/후퇴 여부, 좌우 균형  
                                9. **법령궁(법령)** → 주름 선명도, 길이, 대칭 여부  
                                10. **부모궁(귀)** → 크기, 위치, 형태, 귓볼 크기, 귓바퀴 두께  
                                11. **형제궁(뺨)** → 폭, 볼살 유무, 대칭 여부  
                                12. **관골궁(관골)** → 높이, 돌출/함몰, 폭, 대칭 여부

                                ---

                                **최종 출력 예시**  
                                눈은 크고 쌍꺼풀이 있으며 눈꼬리가 약간 올라가 있고 깊은 눈입니다.  
                                코는 코날이 곧고 높으며, 콧망울이 넓습니다.  
                                입은 작고 양쪽 입꼬리가 올라가 있으며, 윗입술이 두껍습니다.  
                                이마는 넓고 둥글며 중앙에 얕은 가로주름이 있습니다.  
                                눈썹은 길고 진하며 일자 모양입니다.  
                                귀는 크고 귓볼이 두껍고, 위치가 얼굴 중간보다 조금 높습니다.  
                                턱은 짧고 각지며 약간 앞으로 돌출되어 있습니다.  
                                광대는 넓고 약간 발달했습니다.

                                12궁 부위:  
                                - 관록궁(이마): 넓고 매끈함  
                                - 인당궁(미간): 넓고 평탄함  
                                - 자녀궁(눈): 대칭, 크고 또렷함  
                                - 부부궁(광대): 좌우 균형, 적당히 발달  
                                - 재물궁(코): 높고 곧음  
                                - 수명궁(인중): 길고 깊음  
                                - 노복궁(입): 폭 좁고 입꼬리 상승  
                                - 지궁(턱): 각지고 돌출  
                                - 법령궁(법령): 얕고 짧음  
                                - 부모궁(귀): 귓볼 큼, 위치 위쪽  
                                - 형제궁(뺨): 폭 좁음, 볼살 적음  
                                - 관골궁(관골): 돌출, 폭 넓음

                                성별: 남자

                                **예외 예시 (얼굴 자체가 인식되지 않는 경우)**  
                                again
                            """
                            
                            },  # 생략된 지시문 넣기
                            {"inline_data": {"mime_type": "image/jpeg", "data": b64_image}}
                        ]
                    }
                ]
            }

            feature_res = await client.post(GEMINI_API_URL, headers=headers, json=prompt_feature)
            feature_res.raise_for_status()
            features = feature_res.json()["candidates"][0]["content"]["parts"][0]["text"]

            # Step 3: 상세  보고서
            with open("face_report_prompt.txt", "r", encoding="utf-8") as f:
                base_guide = f.read()

            prompt_detail = {
                "contents": [
                    {"parts": [{"text": f"""
                        유저 얼굴 특징: {features}

                        아래는 관상 해석 참고 가이드입니다. 반드시 이 내용을 바탕으로 해석을 작성하세요.
                        {base_guide}    

                        위 내용은 전통 한국 관상 해석에 따른 기준입니다.  
                        이제 위 사용자 얼굴 특징과 관상 해석 가이드를 바탕으로, 아래 10개 항목에 대해 자세한 관상 분석 보고서를 작성하세요.

                        아래는 보고서 제목과 목차야---

                        ## 정통 심층 관상 보고서

                        ### [상정·초년] 이마·눈썹이 말하는 두뇌·가족·첫 사회운  
                        ### [중정·중년] 콧대·광대가 보여주는 재물·권위·도약 시점  
                        ### [하정·말년] 입·턱이 드러내는 가정·건강·노후 복  
                        ### [명궁 총론] 미간이 여는 인생 그래프와 전환점  
                        ### [재백궁] 콧방울·비익이 말해주는 돈의 흐름과 투자 운  
                        ### [관록궁] 이마 중앙 윤곽으로 보는 직업·승진·사업 복  
                        ### [남녀궁] 눈꼬리가 그리는 연애·결혼·배우자 상  
                        ### [자식궁] 인중 길이·깊이로 살피는 자녀 복과 가문의 빛  
                        ### [노복궁] 귀·귓볼이 보여주는 건강·장수·말년 지수  
                        ### [12궁 종합지도] 12궁 상호작용으로 본 인생 파노라마  
                        ### [천기 누설] 팔자를 열어줄 **성형·관리 포인트** 집중 처방

                        ---

                        **✍️ 작성 방식 안내 (꼭 지켜야 할 조건)

                        - 단순한 외형 설명을 넘어, **성격·삶의 흐름·운세·대인관계까지 통합 해석**
                        - 말투는 단호하지만 친근한 관상가 선생님처럼 해주세요. 
                        - 유저에게는 그대라는 표현을 써주세요.
                        - 보고서 내용에 상관없는 이상한 잡다하고 쓸데없는 말 또는 대답은 하지 말고 요청한 보고서 내용만 말해주세요. 
                        - 내담자가 이해하기 쉽게 보고서 형태로 정리를 잘해주어야 합니다. [마크다운 활용을 잘하면 됩니다.]
                        - 이해하기 어려운 표현을 쓰지 말고 내담자가 듣고 싶은 것들에는 굵기, 밑줄 등 강조 표시 해주기
                        - **긍정 70% / 개선점 30% 비율**로 균형 있게 작성

                        ❗️주의: 잡다한 이야기나 여백 채우기식 문장은 절대 금지. 요청한 항목에만 정확히 응답할 것.
                    
                    """}]}
                ]
            }

             
            #          
            detail_res = await client.post(GEMINI_API_URL, headers=headers, json=prompt_detail)
            detail_res.raise_for_status()
            detail = detail_res.json()["candidates"][0]["content"]["parts"][0]["text"]

            # Step 2: 요약
            prompt_summary = {
                "contents": [
                    {"parts": [{"text": f"""
                            {detail}

                            위 내용은 사용자의 자세한 관상 풀이입니다. 위 내용을 기반으로 한 줄 관상을 알려주세요. 
                            요약은 교정 부위는 말해주지 말고, 재물 & 연애 & 인생에 관해서 한 두 줄로 요약해줘. 
                            "무슨 무슨 무슨 할 관상" 으로 요약해줘

                            이상한 잡다한 말과 대화법은 하지 말고 필요한 답변만 해주세요.

                            마지막에는 괄호 안에 100점 만점 기준의 관상 점수를 적어주세요. 점수는 보통 70~100점 사이로 적어주세요.
                            [좋은 관상 같으면 점수를 높게 주고, 조심해야할게 많으면 낮게주세요.] 

                            관상 결과, 점수 말고는 앞뒤에 어떤 말도 하지마세요.
                            아래는 예시일 뿐 실제 관상 풀이 기반으로 요약해주세요. 부위 등 순서는 상관 없습니다.
                            
                            예시:
                            ## 한 줄 관상 및 점수
                            "결혼하면 잘 살 관상" (점수: 93.3점 / 100점)
                    """}]}
                ]
            }

            summary_res = await client.post(GEMINI_API_URL, headers=headers, json=prompt_summary)   
            summary_res.raise_for_status()
            summary = summary_res.json()["candidates"][0]["content"]["parts"][0]["text"]


        return {"summary": summary, "detail": detail, "features": features}

    except Exception as e:
        return {"error": str(e)}


@router.post("/analyze/base")
async def analyze_base(req: FeatureRequest):
    try:
        features = req.feature

        # Step 1: 상세  보고서 프롬프트
        with open("face_report_prompt.txt", "r", encoding="utf-8") as f:
            base_guide = f.read()

        prompt_detail = {
            "contents": [
                {"parts": [{
                    "text": f"""
                        유저 얼굴 특징: {features}

                        아래는 관상 해석 참고 가이드입니다. 반드시 이 내용을 바탕으로 해석을 작성하세요.
                        {base_guide}    

                        위 내용은 전통 한국 관상 해석에 따른 기준입니다.  
                        이제 위 사용자 얼굴 특징과 관상 해석 가이드를 바탕으로, 아래 10개 항목에 대해 자세한 관상 분석 보고서를 작성하세요.

                        아래는 보고서 제목과 목차야---

                        ## 정통 심층 관상 보고서

                        ### [얼굴형] 인생의 기본 성향과 전체적인 운세 흐름
                        ### [이마와 눈썹] 지능, 성장 환경, 가족 인연, 초기 사회운
                        ### [눈과 눈매] 감정 표현, 성격, 대인관계 스타일, 운세의 부침
                        ### [입과 입술] 의사소통 능력, 애정운, 결단력, 가정운
                        ### [턱과 광대] 인내심, 말년운, 권위와 리더십
                        ### [코와 콧대] 재물운, 자립심, 생활력, 사회적 성공 가능성
                        ### [전체적인 인상과 기운] 인생 전반의 조화로움과 복의 흐름
                        ### [운명과 인생 경로] 굴곡 있는 성공·실패의 가능성과 인생의 전환점
                        ### [대인 관계와 인연] 사람들과의 인연 강도와 사회적 호감도
                        ### [종합 결론] 전체 조화를 통해 삶의 균형감과 길흉의 흐름
                        ### [천기 누설] 내 팔자 피게 해줄 성형 부위 

                        ---

                        **✍️ 작성 방식 안내 (꼭 지켜야 할 조건)

                        - 각 항목은 **최소 400자 이상**, 서사적으로 상세하게 작성
                        각 항목은 대략 아래 내용으로 해주면 돼 
                            - [얼굴형] = 인생의 기본 성향과 전체적인 운세 흐름, 인생 그래프 상승 각도 
                            - [이마와 눈썹] = 지능, 성장 환경, 가족 인연, 초기 사회운, 첫 대박 터질 나이 
                            - [눈과 눈매] = 감정 표현, 성격, 대인관계 스타일, 운세의 부침, 끌리는 이상형 본능 코드  
                            - [입과 입술] = 의사소통 능력, 애정운, 결단력, 가정운, 거절 못 할 설득 타율 
                            - [턱과 광대] = 인내심, 말년운, 권위와 리더십, 은퇴 후 반격 모먼트 
                            - [코와 콧대] = 재물운, 자립심, 생활력, 사회적 성공 가능성, 통장이 최고점 찍을 해 
                            - [전체적인 인상과 기운] = 인생 전반의 조화로움과 복의 흐름, 로또급 깜짝 행운 지수  
                            - [운명과 인생 경로] = 굴곡 있는 성공·실패의 가능성과 인생의 전환점, 인생 반전 버튼 작동 시점  
                            - [대인 관계와 인연] = 사람들과의 인연 강도와 사회적 호감도, 귀인 만날 달력 표시  
                            - [종합 결론] = 전체 조화를 통해 삶의 균형감과 길흉의 흐름, 길·흉 총합 승부수 한줄  
                            - [천기 누설] = 내 팔자를 피게 해줄 성형 또는 시술 부위 상세 안내
                        - 단순한 외형 설명을 넘어, **성격·삶의 흐름·운세·대인관계까지 통합 해석**
                        - 말투는 단호하지만 친근한 관상가 선생님처럼 해주세요. 
                        - 유저에게는 그대라는 표현을 써주세요.
                        - 보고서 내용에 상관없는 이상한 잡다하고 쓸데없는 말 또는 대답은 하지 말고 요청한 보고서 내용만 말해주세요. 
                        - 내담자가 이해하기 쉽게 보고서 형태로 정리를 잘해주어야 합니다. [마크다운 활용을 잘하면 됩니다.]
                        - 이해하기 어려운 표현을 쓰지 말고 내담자가 듣고 싶은 것들에는 굵기, 밑줄 등 강조 표시 해주기
                        - **긍정 70% / 개선점 30% 비율**로 균형 있게 작성

                        ❗️주의: 잡다한 이야기나 여백 채우기식 문장은 절대 금지. 요청한 항목에만 정확히 응답할 것.
                    """
                }]}
            ]
        }

        prompt_summary = None  # 나중에 사용

        async with httpx.AsyncClient(timeout=30.0) as client:
            # ✅ 컨텍스트 내에서만 모든 요청 처리
            detail_res = await client.post(GEMINI_API_URL, headers={"Content-Type": "application/json"}, json=prompt_detail)
            detail_res.raise_for_status()
            detail = detail_res.json()["candidates"][0]["content"]["parts"][0]["text"]

            # Step 2: 요약 프롬프트
            prompt_summary = {
                "contents": [
                    {"parts": [{
                        "text": f"""
                            {detail}
                     
                            위 내용은 사용자의 자세한 관상 풀이입니다. 위 내용을 기반으로 한 줄 관상을 알려주세요. 
                            요약은 교정 부위는 말해주지 말고, 재물 & 연애 & 인생에 관해서 한 두 줄로 요약해줘. 
                            "무슨 무슨 무슨 할 관상" 으로 요약해줘

                            이상한 잡다한 말과 대화법은 하지 말고 필요한 답변만 해주세요.

                            마지막에는 괄호 안에 100점 만점 기준의 관상 점수를 적어주세요. 점수는 보통 70~100점 사이로 적어주세요.
                            [좋은 관상 같으면 점수를 높게 주고, 조심해야할게 많으면 낮게주세요.] 

                            관상 결과, 점수 말고는 앞뒤에 어떤 말도 하지마세요.
                            아래는 예시일 뿐 실제 관상 풀이 기반으로 요약해주세요. 부위 등 순서는 상관 없습니다. 
                            
                            예시:
                            ## 한 줄 관상 및 점수
                            "결혼하면 잘 살 관상" (점수: 93.3점 / 100점)
                            """
                    }]}
                ]
            }

            summary_res = await client.post(GEMINI_API_URL, headers={"Content-Type": "application/json"}, json=prompt_summary)
            summary_res.raise_for_status()
            summary = summary_res.json()["candidates"][0]["content"]["parts"][0]["text"]

        return {"summary": summary, "detail": detail}

    except Exception as e:
        return {"error": str(e)}


# ──────────────────────────────────────────────────────────────
#  🚀  /analyze/wealth  – 8개 섹션( detail1 ~ detail8 ) 생성
#      · base_guide  : face_report_prompt.txt 로부터 읽음
#      · feature     : 프론트에서 전달
# ──────────────────────────────────────────────────────────────

class WealthFeatureRequest(BaseModel):
    feature: str   # 얼굴 특징(항목별 묘사)

@router.post("/analyze/wealth")
async def analyze_wealth(req: WealthFeatureRequest) -> Dict[str, str]:
    """
    feature + base_guide 로
    1) 들어가며 ~ 8) 인생 조언까지 detail1-detail8 반환
    """
    try:
        feature = req.feature.strip()

        # (1) 관상 해석용 가이드 읽기
        with open("face_report_prompt.txt", "r", encoding="utf-8") as f:
            base_guide = f.read()

        # (2) 8개 섹션별 지시문 원본
        section_prompts: List[str] = [
            # 1. 들어가며
            '''📘 1. 들어가며
                - 타이틀은 생략해주세요. 제가 따로 코드로 짜서 프론트엔드로 해결할 것입니다.
                - 이 보고서가 무엇이고 어떤 자세한 점을 알 수 있는지를 소개합니다. [이 보고서 제목은: 타고난 부: 내 관상 재물운과 평생 모을 재산은?]
                - 관상을 통해 재물운, 성향, 시기, 조언 등 전반적인 흐름을 해석할 수 있다는 점을 독자에게 설명해주세요.
                - 단순 재미가 아닌 진짜 삶에 도움되는 분석임을 강조해주세요.

                ✅ 이 항목은 최소 **600자 이상**, 권장 **600~800자** 분량으로 작성해주세요.''',

            # 2. 타고난 부와 평생 모을 재산
            '''📘 2. 타고난 부와 평생 모을 재산
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - 관상상 재물 기운이 얼마나 강한지, 평생 동안 얼마만큼의 재산을 모을 수 있는지 구체적인 숫자로 알려주세요. 그리고 이 부분을 해당 보고서에서 강조해주세요. 내담자는 가장 궁금해할 것이고, 진짜 좋은 관상이라 생각되면 금액을 높여도 되고 재물운이 없다면 금액을 낮춰도 됩니다.
                예: "이 상은 평생 ##약 34억 7천만원## 가량의 재산을 축적하게 되오."
                - 반드시 내가 평생 모을 재산을 관상학적 기반으로 구체적으로 추론해서 추가해주세요. 
                - 그리고 평생 모을 재산을 어떤 방식, 어떤 방법으로 모을지 구체적으로 얘기해주면 내담자는 더 좋아합니다. 
                - 초년/중년/노년 시기를 나눠 재물 흐름의 곡선을 설명해주세요.
                
                답변 예시: 
                ## 타고난 부와 평생 모을 재산
                관상 분석 내용 

                ✅ 이 항목은 최소 **1,200자 이상**, 권장 **1,400~1,600자** 분량으로 작성해주세요.''',

            # 3. 타고난 성향과 재물운 장단점
            '''📘 3. 타고난 성향과 재물운 장단점
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - 얼굴형, 눈빛, 이마, 입 등 특징을 바탕으로 이 사람의 성격과 기질을 분석하고, 그것이 돈과 어떤 관계를 가지는지 설명해주세요.
                - 재물운 관점에서 강점과 약점을 나누어 구체적으로 서술해주세요.
                - “이런 유형은 어떤 상황에서 강하다 / 어떤 상황에서 무너진다” 식의 현실 예시 포함.

                답변 예시: 
                ## 타고난 성향과 재물운 장단점
                관상 분석 내용 

                ✅ 이 항목은 최소 **1,200자 이상**, 권장 **1,300~1,500자** 분량으로 작성해주세요.''',

            # 4. 돈이 되는 적성 풀이
            '''📘 4. 돈이 되는 적성 풀이
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - 이 사람은 어떤 성향일 때 돈이 붙는가? 어떤 업이나 환경이 맞는가? 관상을 통해 해석해주세요.
                - 예: ‘분석력 뛰어난 이마형은 혼자 연구하거나 기획하는 일에 강하니…’
                - 고용/자영업/프리랜서/예술/기술 등 현대적 분류도 접목 가능.
                - “자네는 혼자 있을 때 재물이 흩어지고, 사람 속에서 빛나는 기운을 가졌소”와 같은 직접화법 활용.

                답변 예시: 
                ## 돈이 되는 적성 풀이
                관상 분석 내용 

                ✅ 이 항목은 최소 **1,000자 이상**, 권장 **1,200~1,400자** 분량으로 작성해주세요.''',

            # 5. 돈복 터지는 시기와 재산 승부 시기
            '''📘 5. 돈복 터지는 시기와 재산 승부 시기
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - 이 사람은 몇 살 무렵에 돈이 몰리는지, 어떤 시기에 가장 큰 자산을 형성할 수 있는지를 구체적으로 제시해주세요.
                예: “자네는 38세부터 운이 트이기 시작하여, 42세 무렵 승부처가 도래하오.”
                - 시기마다 어떤 유형의 기회를 노려야 하는지도 포함해주세요.
                
                답변 예시: 
                ## 돈복 터지는 시기와 재산 승부 시기
                관상 분석 내용 

                ✅ 이 항목은 최소 **1,200자 이상**, 권장 **1,400~1,600자** 분량으로 작성해주세요.''',

            # 6. 위기/조심해야 할 점
            '''📘 6. 위기/조심해야 할 점
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - 이 사람의 관상에서 손재나 재물의 위기가 올 수 있는 요소를 찾아내어 조언해주세요.
                예: 사람을 잘못 믿어 사기 당할 가능성 / 투자 과욕 / 돌발 소비 패턴 등
                - 단점과 그에 대한 예방책을 짝지어 설명해주세요.
                
                답변 예시: 
                ## 위기/조심해야 할 점
                관상 분석 내용 

                ✅ 이 항목은 최소 **1,000자 이상**, 권장 **1,200~1,400자** 분량으로 작성해주세요.''',

            # 7. 재산이 늘어나는 맞춤 관상 개선법
            '''📘 7. 재산이 늘어나는 맞춤 관상 개선법
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - 관상에서 흐름이 막힌 부분을 설명하고, 그 부분의 기운을 좋게 바꾸는 현실적인 방법을 알려주세요. 재물운 (재산이 늘어나는) 을 늘리는 방향 위주로 설명해주세요. 
                예: 입꼬리 올리기, 눈썹 정리, 미소 유지, 이마 드러내기 등
                - 표정, 태도, 생활 습관 등 구체적으로 제시해주세요.
                
                답변 예시: 
                관상 분석 내용 

                ✅ 이 항목은 최소 **800자 이상**, 권장 **1,000~1,200자** 분량으로 작성해주세요.''',

            # 8. 관상가 양반의 인생 조언
            '''📘 8. 관상가 양반의 인생 조언
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 보고서의 마지막입니다. 마무리 하는 느낌으로 얘기해주세요.
                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - 돈은 수단일 뿐이며, 어떤 삶의 태도를 가지면 후회 없이 살 수 있는지를 조언해주세요.
                - 철학적이면서도 현실적인 메시지를 담고, 관찰된 성향에 어울리는 조언으로 구성해주세요.
                - 마무리는 여운 있는 한마디로.
                
                답변 예시: 
                ## 관상가 양반의 인생 조언
                관상 분석 내용 

                ✅ 이 항목은 최소 **600자 이상**, 권장 **600~800자** 분량으로 작성해주세요.'''
        ]

        headers = {"Content-Type": "application/json"}
        result: Dict[str, str] = {}

        # (3) 8번 순차 호출
        async with httpx.AsyncClient(timeout=60.0) as http_client:
            for idx, instr in enumerate(section_prompts, start=1):
                full_prompt = {
                    "contents": [
                        {"parts": [{
                            "text": f"""
                            말투는 단호하지만 친근한 관상가 선생님처럼 해주세요. 
                            그대, 당신은 이런 말을 너무 자주 쓰지 말아주세요.
                            보고서 내용에 상관없는 이상한 잡다하고 쓸데없는 말 또는 대답은 하지 말고 요청한 보고서 내용만 말해주세요. 
                            내담자가 이해하기 쉽게 보고서 형태로 정리를 잘해주어야 합니다. [마크다운 활용을 잘하면 됩니다.]
                            이해하기 어려운 표현을 쓰지 말고 내담자가 듣고 싶은 것들에는 굵기, 밑줄 등 강조 표시를 해주세요. 

                            ◎ base_guide [관상 가이드 입니다.]
                            {base_guide}

                            ◎ feature [이 유저의 얼굴 특징입니다.]
                            {feature}

                            아래 지시문을 충실히 따르십시오.
                            {instr}
                            """
                        }]}
                    ]
                }

                res = await http_client.post(
                    GEMINI_API_URL,
                    headers=headers,
                    json=full_prompt
                )
                res.raise_for_status()
                section_text = res.json()["candidates"][0]["content"]["parts"][0]["text"]
                result[f"detail{idx}"] = section_text  # detail1, detail2, …

        return result

    except Exception as e:
        return {"error": str(e)}


class WealthMiniRequest(BaseModel):
    feature: str   # 얼굴 특징(항목별 묘사)

@router.post("/analyze/wealth/mini")
async def analyze_wealth_mini(req: WealthMiniRequest) -> Dict[str, str]:
    """
    feature + base_guide 로 간단 3챕터( detail1~detail3 ) 재물운 보고서 반환
    ##
      1) 기본 관상 풀이
      2) 성향과 재물운의 강약점
      3) 돈이 붙는 적성과 환경
    """
    try:
        feature = req.feature.strip()

        # (1) 관상 해석 가이드 읽기
        with open("face_report_prompt.txt", "r", encoding="utf-8") as f:
            base_guide = f.read()

        # (2) 3개 섹션별 지시문
        section_prompts: List[str] = [
            # 1. 기본 관상 풀이  ────────────────────────────────
            '''📘 1. 기본 관상 풀이
                - 얼굴 전체 인상을 요약적으로 풀어 주세요.
                - 긍정 70% / 주의 30% 균형.
                - 그대는 호칭 사용 / 그대는에 맞는 말투 사용 
                - 대답 등 쓸데없는 말은 하지말고 답변만 해줘.
                - **200~300자** 분량, 마크다운 허용.

                답변 예시: 
                ## 점사 결과
                ### 1. 기본 관상 풀이
                관상 분석 내용 
            ''',

            # 2. 성향과 재물운의 강약점  ───────────────────────
            '''📘 2. 성향과 재물운의 강약점
                - 얼굴형, 눈·코·입·이마 등을 근거로
                  ▸ 성격·기질 ▸ 돈 흐름 강점(✅) 3가지 ▸ 약점(⚠️) 2가지 제시.
                - 각각 현실 사례 한 줄 삽입.
                - 그대는 호칭 사용 / 그대는에 맞는 말투 사용 
                - 대답 등 쓸데없는 말은 하지말고 답변만 해줘.
                - **200~400자** 분량.

                답변 예시: 
                ### 📘 2. 성향과 재물운의 강약점
                관상 분석 내용 
            ''',

            # 3. 돈이 붙는 적성과 환경  ───────────────────────
            '''📘 3. 돈이 붙는 적성과 환경
                - 어떤 업·환경·인맥에서 재물이 모이는지 서술.
                - 현대 직업·라이프스타일 예시 OK.
                - “혼자 vs 팀”, “도심 vs 자연” 등 구체적 비교.
                - 마지막 줄: **굵게** 핵심 한 문장 팁으로 마무리.
                - 그대는 호칭 사용 / 그대는에 맞는 말투 사용 
                - 대답 등 쓸데없는 말은 하지말고 답변만 해줘.
                - **200~400자** 분량.

                답변 예시: 
                ### 📘 3. 돈이 붙는 적성과 환경
                관상 분석 내용 
            '''
        ]

        headers = {"Content-Type": "application/json"}
        result: Dict[str, str] = {}

        # (3) 3번 순차 호출
        async with httpx.AsyncClient(timeout=60.0) as http_client:
            for idx, instr in enumerate(section_prompts, start=1):
                full_prompt = {
                    "contents": [
                        {"parts": [{
                            "text": f"""
                                말투는 단호하지만 친근한 관상가 선생님 같습니다.
                                불필요한 잡담·여백 채우기 금지, 요청한 내용만.
                                내담자에게 그대는 호칭 사용 / 그대는에 맞는 말투 사용 
                                내담자가 이해하기 쉬운 마크다운 구조 활용,
                                강조는 **굵게**, _이탤릭_ 정도만.

                                ◎ base_guide (관상 해석 참고)
                                {base_guide}

                                ◎ feature (유저 얼굴 특징)
                                {feature}

                                아래 지시문에 정확히 응답하세요.
                                {instr}
                            """
                        }]}
                    ]
                }

                res = await http_client.post(
                    GEMINI_API_URL,
                    headers=headers,
                    json=full_prompt
                )
                res.raise_for_status()
                section_text = res.json()["candidates"][0]["content"]["parts"][0]["text"]
                result[f"detail{idx}"] = section_text

        return result

    except Exception as e:
        return {"error": str(e)}

class WealthScoreRequest(BaseModel):
    detail1: str

@router.post("/analyze/wealth/score")
async def analyze_wealth_mini(req: WealthScoreRequest) -> Dict[str, str]:
    """
    feature + base_guide 로 간단 3챕터( detail1~detail3 ) 재물운 보고서 반환
    ##
      1) 전체 관상 점수
      2) 한 줄 요약
    """
    try:
        detail1 = req.detail1.strip()

        # (1) 관상 해석 가이드 읽기
        with open("face_report_prompt.txt", "r", encoding="utf-8") as f:
            base_guide = f.read()

        # (2) 3개 섹션별 지시문
        section_prompts: List[str] = [
            # 1. 기본 관상 풀이  ────────────────────────────────
            '''
                사용자의 관상을 보고 70~100 점 사이에서 점수를 메겨주세요. 
                좋은 관상이면 100 점에 가까이 주세요.

                응답은 반드시 숫자만 답해주세요.

                응답 예시: 
                85
            ''',

            # 2. 성향과 재물운의 강약점  ───────────────────────
            '''
                사용자의 관상을 보고 재물 관련된 관상으로 한 줄로 요약해주세요.

                응답은 반드시 다른 말 없이 (약 40글자) 요약만 말해주세요.

                응답 예시 (마크다운 없이): 
                ~~~~ 관상이니라
            '''
        ]

        headers = {"Content-Type": "application/json"}
        result: Dict[str, str] = {}

        # (3) 3번 순차 호출
        async with httpx.AsyncClient(timeout=60.0) as http_client:
            for idx, instr in enumerate(section_prompts, start=1):
                full_prompt = {
                    "contents": [
                        {"parts": [{
                            "text": f"""
                                불필요한 잡담·여백 채우기 금지, 요청한 내용만.

                                ◎ 사용자 관상 결과
                                {detail1}

                                아래 지시문에 정확히 응답하세요.
                                {instr}
                            """
                        }]}
                    ]
                }

                res = await http_client.post(
                    GEMINI_API_URL,
                    headers=headers,
                    json=full_prompt
                )
                res.raise_for_status()
                section_text = res.json()["candidates"][0]["content"]["parts"][0]["text"]
                result[f"score{idx}"] = section_text

        return result

    except Exception as e:
        return {"error": str(e)}


# ──────────────────────────────────────────────────────────────
#  🚀 관상 기반 결혼運 보고서  /analyze/marriage
#      feature + base_guide → detail1~detail6 반환
# ──────────────────────────────────────────────────────────────
class MarriageFeatureRequest(BaseModel):
    feature: str

@router.post("/analyze/marriage")
async def analyze_marriage(req: MarriageFeatureRequest) -> Dict[str, str]:
    """feature + base_guide 로 6개 챕터(detail1~6) 결혼운 보고서 반환"""
    try:
        feature = req.feature.strip()
        with open("face_report_prompt.txt", "r", encoding="utf-8") as f:
            base_guide = f.read()

        section_prompts: List[str] = [

            # 1. 들어가며 ───────────────────────────────────────────
            '''📘 1. 들어가며
                - 타이틀·인사·“등” 표현 생략.  
                - 내부용 제목: “관상으로 읽는 당신의 결혼 로드맵”.  
                - 이 보고서 한 권으로 **만남 타이밍·장소·상대상·관계 유지법**을  
                일목요연하게 얻을 수 있음을 서두에 강조.  
                - “단순 재미 아님, 실전 연애·결혼 전략”임을 못 박는다.  
                - 톤: 따뜻+단호 조선 철학관 × 현대 솔루션 코치.  
                - 중간에 **카운터 미션 1줄**(지금 바로 실행 가능한 행동) 포함.  
                - “인생은 관상이 아니라 ___다” 식 여운 문장 1회.  
                - 끝줄: ‘이제 나침반을 펼쳐보시오.’ 가능.  
                ✅ 600~800자''',

            # 2. 타고난 연애 성향과 결혼관 ─────────────────────────
            '''📘 2. 타고난 연애 성향과 결혼관
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - ‘집중력 라인·소통 에너지·결단 코어·플랜 메모리’ 4지표로 해석.  
                - 내용 구성:  
                ▸ 애정 표현 스타일 + 애착 유형(Secure/Anxious 등)  
                ▸ 결혼 가치관 스펙트럼(안정↔자유, 전통↔동반자)  
                ▸ ✅ 강점 3 / ⚠️ 약점 2 → 각 2문장 해설 + 현실 예시 1줄  
                ▸ *임팩트 숫자* 1회(예: “몰입 지수 78 %”).  
                ✅ 1 300~1 500자''',

            # 3. 결혼수가 열리는 두 번의 골든타임 ──────────────────
            '''📘 3. 결혼수가 열리는 두 번의 골든타임
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - ① 메인 · ② 서브 타임라인(연령·계절·라이프 이벤트) 제시.  
                - 각 시기별:  
                • **만남 스폿 TOP 3**(구체 지명)  
                • 매력 상승 개운법 2~3개(헤어·컬러·패션 키워드)  
                • 실패 요인 + 피해야 할 행동 1줄  
                • “성사 확률 72 %” 등 숫자 1~2회.  
                ✅ 1 400~1 600자''',

            # 4. 이상적 배우자 & 꼬시는 방법 ───────────────────────
            '''📘 4. 이상적 배우자의 얼굴·성격·라이프스타일 & 꼬시는 방법
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 세부 구성:  
                ▸ 외모 포인트(키·체형·이미지 톤) + 패션 코드 → 대표 직업군 2~3개  
                ▸ 가치관·성격 요약 + 상호 보완/충돌 지점  
                ▸ “첫 대화 오프너/톡 주제” 3가지 (📎 리스트)  
                ▸ **끌어당김 스킬 3**: 눈맞춤 길이·목소리 리듬·손 제스처 → 효과·주의  
                ✅ 1 600~1 800자''',

            # 5. 결혼 생활 시뮬레이션 & 갈등 키워드 ─────────────────
            '''📘 5. 결혼 생활 시뮬레이션 & 갈등 키워드
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 경제 분담 시나리오 2종(공동통장 vs 분리) + 장단.  
                - 소통 스타일 차이에서 비롯될 갈등 Top 3 → 해결 루틴 Steps.  
                - 자녀 운 확률: “첫째 75 % / 둘째 40 %” 등 **숫자·퍼센트** 필수.  
                - 갈등 예시 대화 스크립트 1줄.  
                ✅ 1 300~1 500자''',

            # 6. 관상 개선 & 인연을 끌어당기는 실천 체크리스트 ─────
            '''📘 6. 관상 개선 & 인연을 끌어당기는 실천 체크리스트
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 즉시 실행 팁 6~8개: 표정 리셋·헤어 볼륨·치아 톤·향수 레이어링·네일 컬러 등.  
                - “연애운 꽉 잡는 데일리 루틴” → 아침·저녁 2줄 각본.  
                - 마지막: 운명적 인연을 대하는 철학적 한마디.  
                ✅ 1 000~1 200자'''
        ]

        headers = {"Content-Type": "application/json"}
        result: Dict[str, str] = {}

        async with httpx.AsyncClient(timeout=60.0) as http_client:
            for idx, instr in enumerate(section_prompts, start=1):
                full_prompt = {
                    "contents": [
                        {"parts": [{
                            "text": f"""
                                    말투는 단호하지만 친근한 관상가 선생님처럼 해주세요. 
                                    그대, 당신은 이런 말을 너무 자주 쓰지 말아주세요.
                                    보고서 내용에 상관없는 이상한 잡다하고 쓸데없는 말 또는 대답은 하지 말고 요청한 보고서 내용만 말해주세요. 
                                    내담자가 이해하기 쉽게 보고서 형태로 정리를 잘해주어야 합니다. [마크다운 활용을 잘하면 됩니다.]
                                    이해하기 어려운 표현을 쓰지 말고 내담자가 듣고 싶은 것들에는 굵기, 밑줄 등 강조 표시 해주기 

                                    ◎ base_guide
                                    {base_guide}

                                    ◎ feature
                                    {feature}

                                    아래 지시문을 충실히 따르십시오.
                                    {instr}
                                    """
                        }]}
                    ]
                }

                res = await http_client.post(
                    GEMINI_API_URL, headers=headers, json=full_prompt
                )
                res.raise_for_status()
                section_text = res.json()["candidates"][0]["content"]["parts"][0]["text"]
                result[f"detail{idx}"] = section_text  # detail1~detail6

        return result

    except Exception as e:
        return {"error": str(e)}



# ──────────────────────────────────────────────────────────────
#  🚀  연애·운명 위치 보고서  /analyze/love
#      feature + base_guide → detail1~detail7 반환
# ──────────────────────────────────────────────────────────────
class LoveFeatureRequest(BaseModel):
    feature: str  # 얼굴 특징

@router.post("/analyze/love")
async def analyze_love(req: LoveFeatureRequest) -> Dict[str, str]:
    """feature + base_guide 로 7개 챕터(detail1~7) 연애 보고서 반환"""
    try:
        feature = req.feature.strip()

        with open("face_report_prompt.txt", "r", encoding="utf-8") as f:
            base_guide = f.read()

        # 🪞 Peach-Blossom Roadmap – 세부 프롬프트 v3.1
        # (1)~(7) 공통 규칙: 문서 제목 생략 · 새 보고서 느낌 금지 · 욕설/이모지 금지

        # (2) 7개 섹션별 지시문 ──────────────────────────────────────────
        section_prompts: List[str] = [

            # 1. 들어가며
            '''📘 1. 들어가며
                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - 보고서 제목(내부용): “관상으로 읽는 나의 연애 운세".
                - 본 보고서로 얻을 핵심:
                ① 인생 **총 연애 횟수**와 사랑 주기  
                ② 운명 상대의 **실제 거주지(시‧구 단위)**  
                ③ 만남이 터지는 계절·장소 & 매력 버튼  
                ④ 이상적 상대 스펙‧끌어당김 전략  
                ⑤ 사랑 장기 유지법 & 갈등 해결 루틴
                - “단순 재미가 아니라 실전 로드맵”임을 강조.
                - 톤: **따뜻-단호** 조선 철학관 + 현대 실전 예.
                - 마지막 한 줄에 “이제 나침반을 펼쳐보시오.” 식 여운 OK.
                ✅ 400~600자''',

            # 2. 총 연애 횟수 & 사랑 사이클
            '''📘 2. 총 연애 횟수 & 연애 주기
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - 미간(운 기점), 눈꼬리(욕망 곡선), 입술선(감정 표현), 이마(계획성) 분석 →  
                • **총 연애 횟수**(숫자) + “짧은 썸·깊은 관계” 비율  
                • 평균 연애 지속 기간 & 휴식기  
                • “사랑 ON/OFF” 주기 간략 타임라인 (텍스트 막대 그래프 느낌 가능)
                - ✅/⚠️로 **강점 3 / 주의 2** 표기 후 자세 서술.
                - ‘심장이 빨라지는 계절’ 같은 문학적 표현 1회 사용.
                ✅ 1,000~1,200자''',

            # 3. 운명의 상대, 지금 어디에?
            '''📘 3. 운명의 상대, 지금 어디에?
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - 관상상의 지기(地氣) → ★ **대한민국 “△△시 △△구” / “◇◇시 ◇◇구”** 두 곳 제시.  
                • 각 지역을 선택한 관상 논리 한 줄씩 (예: 콧대와 코끝이 뚜렷해 대도시 고소득 밀집지…)  
                • “주 중 이동/재택/출장” 변수로 만남 확률 변주.
                - 온라인 만나기 가능성(플랫폼 타입) 1-2개 보충.
                - “인연 스코어” ★★★☆☆ 형식으로 표시해도 됨.
                ✅ 1,000~1,200자''',

            # 4. 만남이 열리는 계절·장소
            '''📘 4. 만남이 열리는 계절·장소
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - **계절+장소 시나리오 두 세트**:
                ▸ex1) 🌸봄·벚꽃축제  ▸ex2) 🍂가을·북카페
                - 각 세트별로
                • “첫 대화 오프너” 1줄  
                • 매력 상승 개운 액션 2개(헤어·패션·향수·표정)  
                • 실패 요인·피해야 할 행동 1줄
                - 확률(“성사 확률 72%”) 숫자 사용 1회 이상.
                ✅ 1,200~1,400자''',

            # 5. 이상적 상대 & 끌어당김 전략
            '''📘 5. 이상적 상대 관상 & 도화살 전략
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - 이상적 상대 스펙:
                • 얼굴 키포인트(눈매·턱·미소) + 키/체형 한 줄 묘사  
                • 직업·라이프스타일·MBTI 톤 언급 허용  
                • 스킨십·대화 스타일
                - **끌어당김 레버**:  
                ① 눈맞춤 시간 ② 목소리 톤·속도 ③ 손/바디 제스처  
                → 효과·주의 설명.
                - 첫 대화 오프너 3개 (📎 리스트).
                - “첫 데이트 추천 코스” 1줄 덧붙이면 재미↑.
                ✅ 1,000~1,200자''',

            # 6. 연애 성향 강·약점 & 보완법
            '''📘 6. 연애 성향 강·약점 & 보완법
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - ✅ 강점 3  ⚠️ 약점 2 : 헤딩 + 문단 설명.
                - 관상 개선 팁 5개 (▸ 체크리스트):  
                • 미소 각도  • 눈썹 아치  • 퍼스널 컬러  • 데일리 루틴(운동/명상)  • SNS 사진 톤
                - 심리 키워드(애착유형·러브랭귀지)와 관상 연결 1회 설명.
                ✅ 1,000~1,100자''',

            # 7. 오래 가는 사랑 비결
            '''📘 7. 오래 가는 사랑 비결
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 앞에 인사는 생략해주세요. 가이드에 따라 등 표현은 삼가해주세요. 
                - 보고서 시작시 타이틀은 반드시 생략해주세요. 제가 따로 코드로 짤겁니다.
                - 보고서는 여러개를 요청받아 붙이는 형태이므로 새롭게 쓰는 느낌을 주지 마세요. 
                - 전반적인 얼굴 특징에 의한 관상 결과는 알려줄 필요 없습니다. [다른 보고서로 받게 됩니다.]
                - 갈등 트리거 Top3 + 해결 루틴(대화 스크립트 예시 한 줄 포함).
                - ☑️ **관상 개운 체크리스트 5** (아침·저녁 루틴 구분 OK).
                - 마지막 한 문장: 여운·철학적 조언 (“사랑은….”)으로 마무리.
                ✅ 600~800자'''
        ]


        headers = {"Content-Type": "application/json"}
        result: Dict[str, str] = {}

        # 7개 섹션 순차 호출
        async with httpx.AsyncClient(timeout=60.0) as http_client:
            for idx, instr in enumerate(section_prompts, start=1):
                full_prompt = {
                    "contents": [
                        {"parts": [{
                            "text": f"""
                                    말투는 단호하지만 친근한 관상가 선생님처럼 해주세요. 
                                    그대, 당신은 이런 말을 너무 자주 쓰지 말아주세요.
                                    보고서 내용에 상관없는 이상한 잡다하고 쓸데없는 말 또는 대답은 하지 말고 요청한 보고서 내용만 말해주세요. 
                                    **어떤 대답도 하지 말고 바로 보고서를 작성해주세요.**
                                    내담자가 이해하기 쉽게 보고서 형태로 정리를 잘해주어야 합니다. [마크다운 활용을 잘하면 됩니다.]
                                    **표는 활용하지 말고 다른 방법으로 정리르 잘해주세요.**
                                    이해하기 어려운 표현을 쓰지 말고 내담자가 듣고 싶은 것들에는 굵기, 밑줄 등 강조 표시 해주기

                                    ◎ base_guide
                                    {base_guide}

                                    ◎ feature
                                    {feature}

                                    아래 지시문을 충실히 따르십시오.
                                    {instr}
                                    """
                        }]}
                    ]
                }

                res = await http_client.post(
                    GEMINI_API_URL, headers=headers, json=full_prompt
                )
                res.raise_for_status()
                section_text = res.json()["candidates"][0]["content"]["parts"][0]["text"]
                result[f"detail{idx}"] = section_text  # detail1~detail7

        return result

    except Exception as e:
        return {"error": str(e)}

class LoveMiniFeatureRequest(BaseModel):
    feature: str  # 얼굴 특징

@router.post("/analyze/love/mini")
async def analyze_love_mini(req: LoveMiniFeatureRequest) -> Dict[str, str]:
    """
    feature + base_guide 를 결합해 5개 섹션(detail1~5)의 '연애 mini 보고서' 반환
    - 섹션 구조:
        1) 내가 타고난 매력 - 이성이 보는 매력 포인트
        2) 내가 타고난 매력 - 관상 심층 풀이 (간결 버전 + 지수)
        3) 인연이 나타나는 시기 (핵심만)
        4) 내 인연, 어디서 어떻게 만날까 (만남 장소/방법)
        5) 천기누설 - 그 사람과의 연애 진도 (실전 시나리오)
    """
    try:
        feature = (req.feature or "").strip()

        with open("face_report_prompt.txt", "r", encoding="utf-8") as f:
            base_guide = f.read()

        # ─────────────────────────────────────────────────────────────────
        # Mini 섹션 프롬프트 (짧고 실전적인 문장 + 길이 제한)
        # 공통 규칙: 제목/인사/사족 금지, 표 금지, 이모지 1~3개 허용, 마크다운 굵게/리스트 권장
        # ─────────────────────────────────────────────────────────────────
        section_prompts: List[str] = [
            # 1) 이성이 보는 매력 포인트
            """📘 1. 내가 타고난 매력 — 이성이 보는 매력 포인트
- **제목, 인사, 메타 멘트 금지.** 바로 본문 시작.
- **길이 400~600자.**
- 얼굴에서 드러나는 *첫인상 매력 키워드 3~5개*를 한 문장씩 짧게 정리(불릿 가능).
- 예시는 들지 말고, 실제 특징(feature)을 바탕으로 **구체적 디테일**만 제시.
- 이성이 느끼는 심리적 거리/대화 시작 난이도/안정감 여부를 **직접적 문장**으로 표현.
- 감성 표현은 절제(과장/운세 금지). 이모지 1~2개 허용.
""",

            # 2) 관상 심층 풀이 (지수 + 핵심 해석을 간결하게)
            """📘 2. 내가 타고난 매력 — 관상 심층 풀이
- **길이 500~700자. 표 금지.**
- 다음 형식을 유지:
  - **관상 분석 지수(5종)**: 삼정 밸런스 / 오관 조화 / 십이궁 핵심(부부궁·재물궁·관록궁) / 도화 지수 / 홍염 지수
  - 각 지수는 **별점(★ 1~5, 절반은 ☆로 표기 가능)** 한 줄 요약 포함.
  - 이어서 **부위 묘사 4~6개**(이마/눈썹/눈/코/입/턱·광대 등)에서 *왜 매력으로 작동하는지*를 **한 문단씩 간결히**.
- 금지: 운세 단정, 과장, 잡담. 허용: 관상적 기능 설명(실전 매력 관점), 강약 근거.
""",

            # 3) 인연이 나타나는 시기 (핵심만)
            """📘 3. 인연이 나타나는 시기
- **길이 350~500자.**
- 시기 제시는 **연-분기/월 단위**로 간결 명시(예: 2026년 3~4월).
- 컨디션 시그널(표정/피부 윤기/눈 초점/입꼬리 등)과 **액션 플랜 3개**를 불릿으로.
- ‘왜 지금이 유리한지’ 한 줄 근거.
- 과도한 미신/단정 금지. 이모지 최대 1개.
""",

            # 4) 어디서 어떻게 만날까 (장소/방법)
            """📘 4. 내 인연, 어디서 어떻게 만날까
- **길이 500~700자.**
- **장소 2세트**(실내 1, 야외 1) + **만남 방식 2가지**(지인 소개/공동 관심사 등) 제시.
- 각 세트/방식마다
  - **대화 오프너 1줄**
  - **매력 상승 액션 1개**
  - **주의할 실수 1개**
- 숫자(성사 확률 %)는 1회만 사용. 이모지 1~2개 허용.
""",

            # 5) 연애 진도 (실전 시나리오)
            """📘 5. 천기누설 — 그 사람과의 연애 진도
- **길이 450~650자.**
- 1~3회차 데이트의 **거리 좁히기 시나리오**를 단계적으로(번호 리스트).
- 각 단계에: **공간/타이밍/행동(손 제스처/시선/목소리 톤)/한 문장 스크립트**.
- 무리한 스킨십/억지 진행은 금지, 자연스러운 흐름만.
- 마무리 한 줄: “가볍게, 짧게, 웃음 직후 3초.” 같은 실전용 요약.
"""
        ]

        # ─────────────────────────────────────────────────────────────
        # 공통 시스템/콘텍스트 메시지 (톤+규칙 일괄)
        # ─────────────────────────────────────────────────────────────
        base_system = f"""
말투는 단호하지만 친근한 **관상가 선생님**처럼 작성하라.
**인사/제목/메타 멘트/잡담 금지.** 바로 본문 시작.
**표 금지**, 대신 굵게/이탤릭/불릿/번호를 적절히 활용.
과장·단정·욕설·이모지 남발 금지(섹션별 1~3개 허용).
요청한 섹션 이외의 내용은 쓰지 말라. 불필요한 해설·사족 금지.

◎ base_guide
{base_guide}

◎ feature
{feature}
        """.strip()

        headers = {"Content-Type": "application/json"}
        result: Dict[str, str] = {}

        # 5개 섹션 순차 호출
        async with httpx.AsyncClient(timeout=60.0) as http_client:
            for idx, instr in enumerate(section_prompts, start=1):
                full_prompt = {
                    "contents": [
                        {
                            "parts": [
                                {
                                    "text": base_system + "\n\n" + instr
                                }
                            ]
                        }
                    ]
                }

                res = await http_client.post(GEMINI_API_URL, headers=headers, json=full_prompt)
                res.raise_for_status()
                section_text = res.json()["candidates"][0]["content"]["parts"][0]["text"]
                result[f"detail{idx}"] = section_text  # detail1~detail5

        return result

    except Exception as e:
        return {"error": str(e)}


class CareerFeatureRequest(BaseModel):
    feature: str   # 얼굴 특징

@router.post("/analyze/career")
async def analyze_career(req: CareerFeatureRequest) -> Dict[str, str]:
    """
    feature + base_guide 로 7개 챕터(detail1~7) 직업(커리어) 보고서 반환
      └ detail1 → ‘적성과 장단점’, detail7 → ‘관상 개선 실천법’
    """
    try:
        feature = req.feature.strip()

        with open("face_report_prompt.txt", "r", encoding="utf-8") as f:
            base_guide = f.read()

        section_prompts: list[str] = [

            # 1. 들어가며 ───────────────────────────────────────────
            '''📘 1. 들어가며
                - 앞 인사·“등” 표현·불필요한 수식어 절대 금지.  
                - 헤더(제목)는 **삽입하지 말 것**(코드에서 관리).  
                - 동일 의뢰인이 여러 보고서를 순차로 읽으므로  
                **‘새 글’ 냄새·동어 반복**을 피한다.  
                - **얼굴 전체 총평 금지**(세부 평가는 다른 보고서에서 다룸).  
                - 목표:  
                ① 평생 커리어 로드맵의 ‘큰 지도’를 한눈에 제시  
                ② 독자가 지금 당장 실행할 **카운터 펀치** 1줄 미션 포함  
                ③ “인생은 관상이 아니라 ___다” 같은 여운 문장 1회 사용  
                - 톤 & 무드: **따뜻·단호** 조선 철학관 선생 ×  
                현실 비즈니스 코치. 미사여구·추상어 OUT.  
                - 끝줄: ‘이제 나침반을 펼쳐보시오.’ 류 여운 OK.  
                ✅ **400~600자**''',

            # 2. 적성과 장단점 ─────────────────────────────────────
            '''📘 2. 적성과 장단점
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 대신 “집중력 지표·소통 지표·결단 지표·계획성 지표”처럼  
                **4대 핵심 역량 지표**로 설명.  
                - 구성:  
                ▸ **천직 TOP 3**(직무·직종) + “★☆☆☆☆ 난이도” 별점  
                ▸ ✅ 강점 3 / ⚠️ 주의 2  → 각 2~3문장 구체 팁  
                ▸ 약점 2개 + QUICK-TIP 1줄씩  
                ▸ “평생 몰입 지수 **78 %**” 같은 **임팩트 숫자** 1회  
                - ‘심장이 뜨거워지는 월요일’류 문학적 메타포 1회 OK.  
                ✅ **1 000~1 200자**''',

            # 3. 직업 운 곡선(연령별 피크) ─────────────────────────
            '''📘 3. 직업 운 곡선 · 전환점 예측
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 20·30·40·50대 4단 가로 타임라인 → 각 구간 ★★★★☆ 그래프.  
                - 매 구간마다  
                • “승진·이직·관심 산업” 1줄 실전 팁  
                • “전환 이벤트” 예: 학위·전공 변경·해외경험 3가지  
                - 마지막: 커리어 체감 속도 막대(🚀, 🐢) 이모지 활용 가능.  
                ✅ **1 000~1 200자**''',

            # 4. 강점 극대화 전략 ─────────────────────────────────
            '''📘 4. 강점 극대화 전략
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - ① **퍼스널 브랜딩 레버 3개**  
                예) 시그니처 안경, 헤어 가르마, 목소리 톤·속도  
                - ② **업무 루틴·자격증·네트워킹** 패키지 3세트  
                • 루틴: Pomodoro + 리플렉션 노트  
                • 자격: 데이터 분석·PM·CSPO 등  
                • 네트워킹: 산업별 커뮤니티·온라인 포럼  
                - ③ 투자 대비 효과(“ROI **186 %**”) 같은 수치 1회.  
                - 톤: 단호하되 실행 단계가 눈에 보이도록.  
                ✅ **1 000~1 200자**''',

            # 5. 직장 vs 창업 시나리오 ────────────────────────────
            '''📘 5. 직장 vs 창업, 어디서 빛날까?
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - <안정형 직장> : 적합 업종 TOP 2 + 예상 커리어 사다리  
                - <창업형>      : 아이템·BM TOP 2 + 초기 자본·시장 난이도  
                - 양 시나리오별 **이득·리스크** ★★☆☆☆ 막대그래프 느낌 비교.  
                - “창업 실현 확률 **64 %**” 같은 수치 필수.  
                - 5년차·10년차 체크포인트 1줄씩.  
                ✅ **1 000~1 200자**''',

            # 6. 행운의 업무 환경(공간·도시·사람) ──────────────────
            '''📘 6. 행운의 업무 환경
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 구성:  
                ▸ **최적 도시·지역** 2곳 (예: 서울 성수 / 세종시)  
                ▸ **자리 배치·조명·색상** 팁 3개  
                ▸ “협업 시너지 MBTI” 2종(예: ENFJ·INTJ)  
                - 마지막 줄: ‘공간이 기운을 바꾼다’ 철학 한 줄.  
                ✅ **1 000~1 200자**''',

            # 7. 위기 대비 체크 ───────────────────────────────────
            '''📘 7. 위기 대비 체크
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - 재무·건강·번아웃 **리스크 3가지**  
                • 위험 신호 + 대응 루틴 2-step씩  
                - “⚡번아웃 알람 2신호 & 긴급 처방” 상자형 서술.  
                - 보험·저축·멘탈 휴식 루틴 3단계.  
                ✅ **900~1 100자**''',

            # 8. 관상 개선 실천법 ─────────────────────────────────
            '''📘 8. 관상 개선 실천법
                - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.

                - **아침 / 저녁** 루틴 구분:  
                ▸ 표정·피부·헤어·패션·습관 체크리스트 5  
                - 마지막: “관상은 ___다” 철학적 결론 1줄.  
                ✅ **600~800자**'''
        ]

        headers  = {"Content-Type": "application/json"}
        result: Dict[str, str] = {}

        # 지시문 순차 호출 → detail1~7
        async with httpx.AsyncClient(timeout=60.0) as http_client:
            for idx, prompt in enumerate(section_prompts, start=1):
                full_prompt = {
                    "contents": [
                        {"parts": [{
                            "text": f"""
                                    말투는 단호하지만 친근한 관상가 선생님처럼 해주세요. 
                                    그대, 당신은 이런 말을 너무 자주 쓰지 말아주세요.
                                    보고서 내용에 상관없는 이상한 잡다하고 쓸데없는 말 또는 대답은 하지 말고 요청한 보고서 내용만 말해주세요. 
                                    내담자가 이해하기 쉽게 보고서 형태로 정리를 잘해주어야 합니다. [마크다운 활용을 잘하면 됩니다.]
                                    이해하기 어려운 표현을 쓰지 말고 내담자가 듣고 싶은 것들에는 굵기, 밑줄 등 강조 표시 해주기
                                    타이틀을 프론트엔드에서 처리하니 ## 관상 보고서 이런 말은 하지 말고 시작해주세요.


                                    ◎ base_guide
                                    {base_guide}

                                    ◎ feature
                                    {feature}

                                    아래 지시문을 충실히 따르십시오.
                                    {prompt}
                                    """
                        }]}
                    ]
                }

                res = await http_client.post(
                    GEMINI_API_URL, headers=headers, json=full_prompt
                )
                res.raise_for_status()
                detail = res.json()["candidates"][0]["content"]["parts"][0]["text"]
                result[f"detail{idx}"] = detail        # detail1~detail7

        return result

    except Exception as e:
        return {"error": str(e)}

class CoupleReportRequest(BaseModel):
    features1: str
    features2: str
    relationshipType: str
    relationshipFeeling: str

@router.post("/analyze/couple/report")
async def analyze_couple_report(req: CoupleReportRequest) -> Dict[str, str]:
    try:
        f1, f2 = req.features1.strip(), req.features2.strip()
        with open("face_report_prompt.txt", "r", encoding="utf-8") as f:base_guide = f.read()

        section_prompts = [
            # 1. 성격 궁합 분석
            f'''
            ## 두 사람의 성격 궁합 분석 🙌  
            **서로의 기질이 어떤 케미를 만들어낼까?**

            이 항목은 두 사람의 타고난 성격, 에너지 흐름, 표현 방식 등을 관상(얼굴 특징) 기반으로 파악해  
            지금의 관계(**{req.relationshipType}**)에 어떤 영향을 미치는지 설명하기 위한 리포트야.

            특히 내담자가 느끼는 감정(**{req.relationshipFeeling}**)을 고려해서  
            기대되는 포인트와 갈등 요소를 함께 짚어줘. 예시는 구체적으로, 현실적인 관점으로 분석해줘.

            - 직관적인 성격 묘사와 예시
            - 긍정적 포인트 + 갈등 가능성 모두 포함
            - 마크다운 / 600~900자
            ''',

            # 2. 연애 스타일 & 케미
            f'''
            ## 관상으로 보는 연애 스타일 🌸  
            **연애할 때 드러나는 두 사람의 모습은?**

            이 항목은 관상을 통해 두 사람이 연애할 때 어떤 스타일인지(표현 방식, 감정 흐름, 이상형, 욕구 등)를 분석하고  
            실제 커플로서 얼마나 케미가 잘 맞을지 진단하는 내용이야.

            특히 지금 관계(**{req.relationshipType}**)와 내담자의 감정(**{req.relationshipFeeling}**)을 고려해서  
            타이밍이 잘 맞는지, 서로의 기대가 충돌할 가능성은 없는지도 현실적으로 짚어줘.

            - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.
            - 연애 시 모습, 이상형, 욕구 스타일 분석
            - 케미, 타이밍 판단 포함
            - 마크다운 / 800~1000자
            ''',

            # 3. 나의 매력 + 유혹 전략
            f'''
            ## 그 사람을 유혹하는 비법 🙈  
            **상대가 끌리는 나의 포인트는 무엇일까?**

            이 항목은 내담자의 얼굴 특징에서 '잘 드러나지 않았던 매력'을 2~3가지 발굴하고,  
            그것을 이용해 상대(**{req.relationshipType}**)를 효과적으로 끌어당길 수 있는 유혹 전략을 조언하는 내용이야.

            특히 상대의 욕구·결핍·관심사에 내 매력을 어떻게 연결하면 좋을지 알려주고,  
            마지막엔 한 줄로 조언을 마무리해줘. (간결하지만 인상적으로!)

            - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.
            - 숨겨진 매력 포인트 2~3가지
            - 관계를 진전시키는 전략
            - 마크다운 / 700~900자
            ''',

            # 4. 헤어질 가능성과 주의할 점
            f'''
            ## 헤어지는 원인과 가능성 💔  
            **우리 관계의 위태로운 지점은 무엇일까?**

            이 항목은 두 사람의 얼굴 관상을 바탕으로,  
            앞으로 헤어질 수 있는 결정적 요인을 분석하는 리포트야.  
            특히 현재의 관계 상태(**{req.relationshipType}**)와 감정(**{req.relationshipFeeling}**)에 맞춰  
            갈등의 불씨가 될 요소, 놓치고 있는 위험 신호 등을 현실적으로 짚어줘.

            끝으로 이 관계가 계속되기 위해 필요한 조치나 태도 변화에 대해 조언해줘.

            - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.
            - 헤어질 가능성이 높은 요인 2~3개
            - 위험 신호 + 조심할 점
            - 마크다운 / 700~1000자
            ''',

            # 5. 속궁합 분석 (강렬하게)
            f'''
            ## 관상으로 보는 속궁합 분석 🔥  
            **우리는 실제로 만나면 얼마나 불타오를까?**

            이 항목은 얼굴의 눈빛, 입술, 코, 분위기 등을 바탕으로  
            두 사람의 성적 텐션과 궁합을 분석하는 강렬한 리포트야.

            특히 상대방이 끌리는 내 신체적 매력 포인트,  
            실제 관계에서의 텐션, 만족도, 판타지 충족 여부 등을 적나라하게 설명해줘.  
            적나라하고 대담하고 솔직한 표현과 단어들을 써줘. [낮저밤이 등]

            마지막은 “우리 둘이 실제로 만나면 얼마나 뜨거울까?” 라는 질문에 답하듯  
            임팩트 있게 마무리해줘.

            - **부위 명칭·삼정·12궁·오관 분석 언급 절대 금지**.
            - 시각적/성적 매력 포인트
            - 텐션·시너지·환상 분석
            - 적나라하지만 불쾌하지 않게
            - 마크다운 / 900~1200자
            '''
        ]

        headers = {"Content-Type": "application/json"}
        result = {}

        async with httpx.AsyncClient(timeout=60.0) as http_client:
            for idx, prompt in enumerate(section_prompts, start=1):
                full_prompt = {
                    "contents": [
                        {"parts": [{
                            "text": f"""
                                        다음은 커플 궁합 리포트 작성 요청입니다.
                                        이 커플의 현재 관계 유형은 다음과 같습니다: **{req.relationshipType}**
                                        그리고 내담자의 현재 감정 상태는 다음과 같습니다: **{req.relationshipFeeling}**

                                        [내담자의 얼굴 특징, 성별 포함]
                                        {req.features1}

                                        [상대방의 얼굴 특징, 성별 포함]
                                        {req.features2}

                                        --------------------
                                        [참조 가이드]
                                        {base_guide}
                                        --------------------

                                        아래 요청에 정확히 응답하세요:
                                        {prompt}
                                    """
                        }]}
                    ]
                }

                res = await http_client.post(
                    GEMINI_API_URL,
                    headers=headers,
                    json=full_prompt
                )
                res.raise_for_status()
                section_text = res.json()["candidates"][0]["content"]["parts"][0]["text"]
                result[f"detail{idx}"] = section_text

        return result

    except Exception as e:
        return {"error": str(e)}
    
class CoupleScoreRequest(BaseModel):
    detail1: str  # 위의 detail1 리포트 (요약용)

@router.post("/analyze/couple/score")
async def analyze_couple_score(req: CoupleScoreRequest) -> Dict[str, str]:
    try:
        d1 = req.detail1.strip()

        prompts = [
            '''
            사용자의 커플 리포트를 참고해서 70~100점 사이의 궁합 점수를 부여해주세요.
            궁합이 좋으면 100점에 가까운 점수, 안좋으면 70점에 가까운 점수를 부여해주세요. 
            궁합 내용 기반으로 점수를 잘 산정해주세요. 좋다면 100점에 가까운 점수를 꼭 해주세요.
            답변은 반드시 숫자만! 예: 93
            ''',

            '''
            커플 리포트를 바탕으로 한 문장으로 요약된 궁합을 작성해주세요.
            예: “환상의 티키타카, 둘이 만나면 폭죽처럼 터지는 궁합이에요”
            '''
        ]

        headers = {"Content-Type": "application/json"}
        result = {}

        async with httpx.AsyncClient(timeout=60.0) as http_client:
            for idx, prompt in enumerate(prompts, start=1):
                full_prompt = {
                    "contents": [
                        {"parts": [{
                            "text": f"""
                                아래는 커플 궁합 리포트입니다.
                                이 내용을 참고하여 아래 요청을 정확히 수행하세요.

                                [궁합 리포트 요약]
                                {d1}

                                요청:
                                {prompt}
                            """
                        }]}
                    ]
                }

                res = await http_client.post(
                    GEMINI_API_URL,
                    headers=headers,
                    json=full_prompt
                )
                res.raise_for_status()
                reply = res.json()["candidates"][0]["content"]["parts"][0]["text"]
                result[f"score{idx}"] = reply.strip()

        return result

    except Exception as e:
        return {"error": str(e)}
    


class ReunionReportRequest(BaseModel):
    features1: str
    features2: str
    relationshipType: str         # interest | crush | fling | dating | ghosting | affair
    relationshipFeeling: str      # "나" | "상대방" (이 문자열이 그대로 넘어옴)


class ReunionChanceRequest(BaseModel):
    detail1: str                  # 위 리포트의 detail1 전문


# ── 1) 재회 전략 리포트 엔드포인트 ───────────────────────────────────────
@router.post("/analyze/reunion/report")
async def analyze_reunion_report(req: ReunionReportRequest) -> Dict[str, str]:
    """
    detail1~5: 재회 전략 섹션 반환
    """
    try:
        with open("face_report_prompt.txt", encoding="utf-8") as f:
            base_guide = f.read()

        # 요청자가 먼저? 상대가 먼저?
        initiator_text = "내가 먼저" if req.relationshipFeeling == "나" else "상대가 먼저"

        section_prompts = [
            # 1) 이별 원인 & 핵심 갈등 구조
            f"""
            ## 1. 이별 원인 & 핵심 갈등 구조 🔍
            - 현재 관계 유형: **{req.relationshipType}**
            - 이별 선포: **{req.relationshipFeeling}**

            관상 특징을 근거로 두 사람이 부딪힌 지점·트리거를
            구체적 상황 예시와 함께 분석해 줘.
            미래에 다시 만나도 같은 갈등이 반복될 가능성까지 짚어 줘.
            내담자와, 상대방이라고 표현해줘. 
            """,

            # 2) 미련 & 현재 심리 상태
            f"""
            ## 2. 미련 & 현재 심리 상태 🫀
            두 사람 얼굴에 드러난 감정 잔여물(미련·후회·자존심 등)과
            재회를 가로막는 내부 심리 장벽을 현실적인 어조로 설명해 줘.
            """,

            # 3) 재회 방해 요소 + 제거 전략
            f"""
            ## 3. 재회 방해 요소 + 제거 전략 🛠️
            현실적 장애물(제3자·거리·가족·금전·성격차)을 2-3개 꼽고,
            각 요소를 어떻게 완화·해소할지 단계별 행동 팁을 제시해 줘.
            """,

            # 4) 재접근 로드맵
            f"""
            ## 4. 재접근 로드맵 📞
            ① 첫 연락 타이밍·톤  
            ② 만나서 할 대화 소재  
            ③ 관계 재정립 TIP  
            을 단계별 체크리스트 형식으로 작성해 줘.
            """,

            # 5) 예상 시나리오 & 현실적 확률
            f"""
            ## 5. 예상 시나리오 & 현실적 확률 📊
            3개월·6개월·1년 단위로
            재회 성공·부분 회복·최종 결별 시나리오를 서술하고
            **각 확률(%)** 을 제시해 줘.
            """
        ]

        headers = {"Content-Type": "application/json"}
        result: Dict[str, str] = {}

        async with httpx.AsyncClient(timeout=60) as client:
            for idx, prompt in enumerate(section_prompts, 1):
                full_prompt = {
                    "contents": [{
                        "parts": [{
                            "text": f"""
                            [내담자의 얼굴 특징, 성별 포함]
                            {req.features1}

                            [상대방의 얼굴 특징, 성별 포함]
                            {req.features2}

                            --------------------
                            {base_guide}
                            --------------------

                            {prompt}
                            """
                        }]
                    }]
                }
                r = await client.post(GEMINI_API_URL, headers=headers, json=full_prompt)
                r.raise_for_status()
                result[f"detail{idx}"] = r.json()["candidates"][0]["content"]["parts"][0]["text"].strip()

        return result

    except Exception as e:
        return {"error": str(e)}


# ── 2) 재회 확률 & 한 줄 요약 ──────────────────────────────────────────
# ── 2) 재회 확률 & 요약 엔드포인트 수정 ────────────────────────
@router.post("/analyze/reunion/chance")
async def analyze_reunion_chance(req: ReunionChanceRequest) -> Dict[str, str]:
    """
    detail1을 바탕으로
      chance1: 0~100 숫자 (재회 확률 %)
      chance2: 한 문장 요약·조언
    """
    try:
        d1 = req.detail1.strip()

        prompts = [
            f"""
            위 detail1 내용을 바탕으로 두 사람이 **3개월 안에 재회**할 현실적 확률을
            0~100 사이 정수로만 답변하세요. 예: 68
            """,
            f"""
            detail1 을 통해
            재회를 위해 내담자가 가져야할 가장 중요한 행동·마인드 조언을 한 줄로 짧게 요약 제시해주시고 내담자와 상대방이라는 표현을 써주세요.
            """
        ]

        headers = {"Content-Type": "application/json"}
        result: Dict[str, str] = {}

        async with httpx.AsyncClient(timeout=30.0) as http_client:
            for idx, prompt in enumerate(prompts, start=1):
                full_prompt = {
                    "contents": [
                        {"parts": [{
                            "text": f"""
                                [detail1]
                                {d1}

                                --------------------
                                요청:
                                {prompt}
                            """
                        }]}
                    ]
                }

                res = await http_client.post(
                    GEMINI_API_URL,
                    headers=headers,
                    json=full_prompt
                )
                res.raise_for_status()
                reply_text = res.json()["candidates"][0]["content"]["parts"][0]["text"].strip()

                # chance1 → 확률(숫자), chance2 → 한 줄 요약
                result[f"chance{idx}"] = reply_text

        return result

    except Exception as e:
        return {"error": str(e)}