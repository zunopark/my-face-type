from fastapi import APIRouter, File, UploadFile
import base64, requests
import re, textwrap, httpx, os
from utils.resize import resize_image
from pydantic import BaseModel
from typing import Dict, List

router = APIRouter()

from openai import OpenAI

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
GEMINI_API_URL = f"https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key={GEMINI_API_KEY}"

class FeatureRequest(BaseModel):
    feature: str  # 프론트에서 받은 얼굴 특징 전체

@router.post("/face-teller/")
async def analyze_image(file: UploadFile = File(...)):
    try:
        content = await file.read()
        b64_image = await resize_image(content)

        headers = {"Content-Type": "application/json"}

        async with httpx.AsyncClient(timeout=60.0) as client:

            # Step 1: 특징 추출
            prompt_feature = {
                "contents": [
                    {
                        "parts": [
                            {"text": """
                                아래는 얼굴 특징 분석 요청입니다.

                                ### 1. 각 항목별로 사진에서 '겉으로 보이는 외형적 특징'만 한국어로 객관적으로 설명해 주세요.  
                                2. 절대 성격, 운세, 해석 등 주관적 해설은 하지 마세요. 오직 보이는 사실만 묘사해야 합니다.  
                                3. 반드시 항목별로 아래 예시 형식을 따라주세요.  
                                4. 아래 표의 분류/키워드 중 실제 해당하는 것은 빠짐없이 모두 기술하세요.  
                                5. 여러 특징이 동시에 보이면 모두 작성하세요.  
                                6. **얼굴 전체가 인식되지 않을 경우에만 'again'이라는 단어 하나만 출력하세요.**
                                - 일부 부위가 가려져도, 보이는 부위는 반드시 묘사하세요.
                                - 단, 얼굴이 전혀 인식되지 않거나 분석 불가 시에는 무조건 `again`만 출력.
                                7. **오관(눈·코·입·귀·눈썹), 삼정(상정·중정·하정), 12궁(각 부위의 모양·크기·위치·대칭 여부)을 반드시 포함해 설명하세요.**
                                8. 12궁 설명 시 각 부위의 형태, 크기, 위치, 대칭, 돌출·함몰 여부, 주름·점·흉터 유무, 길이/깊이 등 구체적으로 묘사하세요.

                                ---

                                ✅ 오관 (눈·코·입·귀·눈썹)  
                                👁️ 눈: 크기/형태(큰눈/작은눈/가느다란눈), 눈꼬리(올라감/처짐), 깊이(깊은눈/튀어나온눈), 쌍꺼풀 여부  
                                👃 코: 코날(우뚝/굽음), 높이(높음/낮음), 크기(크다/작다), 콧망울 형태, 콧대 두께  
                                👄 입: 크기(큰입/작은입), 입꼬리(올라감/처짐), 입술 두께(윗입술 두꺼움/아랫입술 두꺼움/얇음), 대칭 여부  
                                🪒 눈썹: 길이(긴/짧은), 두께(진한/엷은), 모양(일자/초승달/八자), 방향(치켜진/처진)  
                                👂 귀: 크기(크다/작다), 위치(위쪽/아래쪽), 귓볼(크다/작다/두껍다/얇다), 귀 각도(앞으로/뒤로 젖혀짐)

                                ---

                                ✅ 삼정  
                                - **상정(이마~눈썹)**: 이마 높이, 너비, 주름, 모양(둥근/네모진/M자형), 피부 표면  
                                - **중정(눈~코~광대)**: 광대 발달 정도, 코 크기와 높이, 코끝 모양, 비대칭 여부  
                                - **하정(코끝~턱)**: 입 모양, 턱 길이, 턱선 각도, 돌출/후퇴 여부

                                ---

                                ✅ 12궁 (사진에서 확인 가능한 외형 기준)  
                                1. **관록궁(이마)** → 넓이, 높이, 형태(둥근/네모/튀어나옴), 주름·흉터 여부  
                                2. **인당궁(미간)** → 너비, 평탄함/패임, 주름·점 유무  
                                3. **자녀궁(눈)** → 크기, 모양, 쌍꺼풀 유무, 대칭 여부  
                                4. **부부궁(광대)** → 크기, 높이, 폭, 돌출/함몰, 대칭 여부  
                                5. **재물궁(코)** → 길이, 폭, 콧대 모양, 콧망울 크기  
                                6. **수명궁(인중)** → 길이(짧음/김), 깊이(깊음/얕음), 대칭 여부, 주름·점 유무  
                                7. **노복궁(입)** → 크기, 폭, 입꼬리 방향, 대칭 여부  
                                8. **지궁(턱)** → 길이, 폭, 각도, 돌출/후퇴 여부, 좌우 균형  
                                9. **법령궁(법령)** → 주름 선명도, 길이, 대칭 여부  
                                10. **부모궁(귀)** → 크기, 위치, 형태, 귓볼 크기, 귓바퀴 두께  
                                11. **형제궁(뺨)** → 폭, 볼살 유무, 대칭 여부  
                                12. **관골궁(관골)** → 높이, 돌출/함몰, 폭, 대칭 여부

                                ---

                                **최종 출력 예시**  
                                눈은 크고 쌍꺼풀이 있으며 눈꼬리가 약간 올라가 있고 깊은 눈입니다.  
                                코는 코날이 곧고 높으며, 콧망울이 넓습니다.  
                                입은 작고 양쪽 입꼬리가 올라가 있으며, 윗입술이 두껍습니다.  
                                이마는 넓고 둥글며 중앙에 얕은 가로주름이 있습니다.  
                                눈썹은 길고 진하며 일자 모양입니다.  
                                귀는 크고 귓볼이 두껍고, 위치가 얼굴 중간보다 조금 높습니다.  
                                턱은 짧고 각지며 약간 앞으로 돌출되어 있습니다.  
                                광대는 넓고 약간 발달했습니다.

                                12궁 부위:  
                                - 관록궁(이마): 넓고 매끈함  
                                - 인당궁(미간): 넓고 평탄함  
                                - 자녀궁(눈): 대칭, 크고 또렷함  
                                - 부부궁(광대): 좌우 균형, 적당히 발달  
                                - 재물궁(코): 높고 곧음  
                                - 수명궁(인중): 길고 깊음  
                                - 노복궁(입): 폭 좁고 입꼬리 상승  
                                - 지궁(턱): 각지고 돌출  
                                - 법령궁(법령): 얕고 짧음  
                                - 부모궁(귀): 귓볼 큼, 위치 위쪽  
                                - 형제궁(뺨): 폭 좁음, 볼살 적음  
                                - 관골궁(관골): 돌출, 폭 넓음

                                성별: 남자

                                **예외 예시 (얼굴 자체가 인식되지 않는 경우)**  
                                again
                            """
                            
                            },  # 생략된 지시문 넣기
                            {"inline_data": {"mime_type": "image/jpeg", "data": b64_image}}
                        ]
                    }
                ]
            }

            feature_res = await client.post(GEMINI_API_URL, headers=headers, json=prompt_feature)
            feature_res.raise_for_status()
            features = feature_res.json()["candidates"][0]["content"]["parts"][0]["text"]

            with open("face_report_prompt.txt", "r", encoding="utf-8") as f:
                base_guide = f.read()

            prompt_detail = {
                "contents": [
                    {"parts": [{"text": f"""
                        유저 얼굴 특징(객관 묘사 결과, 그대로 신뢰해 사용할 것):
                        {features}

                        전통 한국 관상 해석 참고 가이드(근거·개념·용어 정의로만 활용):
                        {base_guide}

                        ────────────────────────────────────────
                        # 출력 목적
                        - **오직 '부위별 관상'**만 작성한다. 
                        - 문장은 전부 **2인칭 직접화법**으로 쓴다: “**코를 보아하니…**”, “**눈썹을 보니…**”
                        - 사전식·교과서식 설명(“코 크기는 ~이다”) 금지. **관찰 → 해석 → 삶의 장면**으로 자연스럽게 연결.
                        - 중간 중간 팁 등 보고서 자체를 글로만 표현하는게 아니라 다양하게 다체롭게 표현해주고 마크다운을 자유롭게 사용해줘.
                        - 표나 별표, 막 이런걸로 보기 좋게 보고서 느낌처럼 잘 표현하는 출력을 만들어줘. markdown 을 잘 사용해봐!
                        - 한글 기준 **5,500±500자(공백 포함)**.

                        # 금지 규정
                        - 수치화/등급화/점수화/별점/지수/그래프/표 금지.
                        - 메타 발화(“요청하신 보고서는…”, “설명하겠습니다…”, “앞서 말씀드린…”) 금지.
                        - 불필요한 외국어·음차 남용 금지. 필요한 한자어는 짧게 괄호 풀이.
                        - “사진에서 보이지 않아 판단 불가”와 같은 단정 금지. **보이는 범위 내**에서 신중히 기술.
                        - "너의 ~ " 이 워딩 금지.

                        # 보고서 구성(반드시 이 순서·형식 준수)
                        ## 관상가 양반이 보는 첫인상
                        - 보고서 톤을 정돈하는 짧은 서문.  
                        - 2인칭으로 ‘얼굴에서 먼저 들어오는 인상’을 한 단락로 제시.  
                        - 금기: 자기소개/과장/점괘식 선언. 과학적·관찰적 어휘 유지.

                        ## 2) 오관(五官) 정밀 서술
                        아래 다섯 부위를 **각각 2~3문단**씩. 각 부위마다 다음 **문단 구조**를 지킨다.
                        - **문단 A (관찰 시작문)**: “**[부위]를 보아하니…**”로 시작. 형태·선·면·밀도·윤곽·대칭·연결부 묘사.
                        - **문단 B (해석 전개)**: 관찰 근거로 유추되는 **성향/기질/반응 패턴**을 일상 언어로 연결.
                        - **문단 C (생활 장면)**: 구체 장면 1~2개(대화/일/대인/결정 순간). **직접화법 유지**.
                        - **필수 연결 문장**(각 부위 마지막이나 별도 1문장): 인접 부위와의 **호응·긴장·보완** 관계를 짚는다.
                        - 다섯 부위 공통 어조: 담담·정확·오버금지.  
                        부위 순서는 고정:
                        ### 눈
                        ### 코
                        ### 입
                        ### 귀
                        ### 눈썹

                        ## 3) 다섯 관리(官)의 협업도 (1~2문단)
                        - “**눈과 코가 서로 호응하며…**”처럼 **부위-부위 상호작용**을 한 호흡으로 정리.  
                        - 흩어진 장점이 **언제 결합되고, 언제 충돌하는지**를 구체 장면으로.

                        ## 4) 삼정(三停) 입체 분석 — 상정/중정/하정 (각 1~2문단)
                        각 정(停)마다 **형태 관찰 → 성향/행동 패턴 → 시기(초·중·말년)의 장면** 순으로.
                        - “**상정은…**”, “**중정은…**”, “**  하정은…**”로 시작.  
                        - 시기 언급은 **감정·관계·일의 태도 변화** 같은 **행동 리듬** 위주로, 점술적 단정 금지.

                        ## 5) 12궁 정밀 해석 (자연 문단, 최소 8개 궁 이상)
                        - 각 궁을 문단 첫 문장에 **굵게 궁 이름**을 표기하고(예: “**관록궁(이마)** …”),  
                        뒤는 **형태 관찰 → 길·흉의 경향 → 일상에서 선택/관계/기회로 드러나는 방식** 1~3문장.  
                        - **중복·나열 금지**: 비슷한 의미는 묶어 정리하고, 실제 **얼굴 구조의 논리**를 따른다.
                        - 사진에 따라 **식별 가능한 부위만** 신중히 다루되, 최소 8개 궁은 충족.

                        ## 6) 종합 진단 — 균형/불균형과 행동 제안 (2~3문단)
                        - 오관·삼정·12궁의 결과를 **상호작용의 관점**으로 모은다.  
                        - **균형일 때의 장면 / 불균형일 때의 장면**을 대비.  
                        - 마지막 문단에는 **행동 제안 3문장**(문장 형태, 번호·목록·표 금지).  
                        - 예: “너는 중요한 결정을 미루고 싶어질 때, 먼저 ○○를 정리해라.” 같은 **직접적 2인칭 지시문**.

                        ## 7) 천기누설 — 성형 또는 시술 추천 (각 2~3문장)
                        - 각 팁은 **왜 너에게 맞는지**를 얼굴 구조와 **인과적으로 연결**.  

                        # 스타일 가이드(출력문 전체에 적용)
                        - **항상 2인칭**: “~을 보아하니/보니/드러나니/비추니/받아내니…” 다양하게 활용.  
                        - 형용사만 나열하지 말고, **선(라인)·면(볼륨)·각(각도)·밀도(모발·모공·주름)·텍스처(광택·거칠기)** 같은 **물리 어휘**를 최소 각 부위 1회 이상 사용.  
                        - 원인-결과 **인과 연결어**(그래서, 그러므로, 그 탓에, 덕분에, 다만)를 적극 사용해 단락을 매끈히 잇는다.  
                        - 과장·단정 지양, **관찰 근거가 보이는 문장** 우선.  
                        - 목록·표·인용·점수·별도 요약 금지. **제목과 본문**만 출력.

                        # 최종 출력 형식(이 틀만 출력, 다른 말 일절 금지)
                        ## 1. 관상가 양반이 보는 첫인상
                        [3~5문장]

                        ## 2. 오관(五官) 정밀 서술
                        ### 눈
                        [2~3문단]
                        ### 코
                        [2~3문단]
                        ### 입
                        [2~3문단]
                        ### 귀
                        [2~3문단]
                        ### 눈썹
                        [2~3문단]

                        ## 3. 다섯 관리(官)의 협업도
                        [1~2문단]

                        ## 4. 삼정(三停) 입체 분석
                        ### 상정
                        [1~2문단]
                        ### 중정
                        [1~2문단]
                        ### 하정
                        [1~2문단]

                        ## 5. 12궁 정밀 해석
                        [최소 8개 궁 이상, 궁 이름을 굵게 시작하는 자연 문단들]

                        ## 6. 균형/불균형과 행동 제안
                        [2~3문단, 마지막 3문장은 직접 지시문]

                        ## [천기누설] 성형 또는 시술 추천
                        [2~3가지, 각 2~3문장]
                    """}]}
                ]
            }

             
            #          
            detail_res = await client.post(GEMINI_API_URL, headers=headers, json=prompt_detail)
            detail_res.raise_for_status()
            detail = detail_res.json()["candidates"][0]["content"]["parts"][0]["text"]

            # Step 2: 요약
            prompt_summary = {
                "contents": [
                    {"parts": [{"text": f"""
                            {detail}

                            위 내용은 사용자의 자세한 관상 풀이입니다. 위 내용을 기반으로 한 줄 관상을 알려주세요. 
                            요약은 교정 부위는 말해주지 말고, 재물 & 연애 & 인생에 관해서 한 두 줄로 요약해줘. 
                            "무슨 무슨 무슨 할 관상" 으로 요약해줘

                            이상한 잡다한 말과 대화법은 하지 말고 필요한 답변만 해주세요.

                            마지막에는 괄호 안에 100점 만점 기준의 관상 점수를 적어주세요. 점수는 보통 70~100점 사이로 적어주세요.
                            [좋은 관상 같으면 점수를 높게 주고, 조심해야할게 많으면 낮게주세요.] 

                            관상 결과, 점수 말고는 앞뒤에 어떤 말도 하지마세요.
                            아래는 예시일 뿐 실제 관상 풀이 기반으로 요약해주세요. 부위 등 순서는 상관 없습니다.
                            
                            예시:
                            "결혼하면 잘 살 관상" (점수: 93.3점 / 100점)
                    """}]}
                ]
            }

            summary_res = await client.post(GEMINI_API_URL, headers=headers, json=prompt_summary)   
            summary_res.raise_for_status()
            summary = summary_res.json()["candidates"][0]["content"]["parts"][0]["text"]


        return {"summary": summary, "detail": detail, "features": features}

    except Exception as e:
        return {"error": str(e)}

